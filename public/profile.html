<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Peer2Skill</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: '#6366f1',
                        brandDark: '#4f46e5',
                        brandLight: '#e0e7ff',
                        bgMain: '#f3f4f6', /* Light gray background for contrast */
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-bgMain text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <nav class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-2 text-gray-500 hover:text-brand transition font-medium">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-brandLight hover:text-brand">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <span class="hidden sm:inline">Back to Feed</span>
            </a>
            <div class="h-6 w-px bg-gray-300 mx-2 hidden sm:block"></div>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight">Profile</h1>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleEditModal()" class="flex items-center gap-2 px-4 py-2 bg-brandLight text-brand rounded-lg font-semibold text-sm hover:bg-brand hover:text-white transition">
                <i class="fas fa-pen"></i> <span class="hidden sm:inline">Edit Profile</span>
            </button>
            <div class="w-9 h-9 rounded-full bg-brand text-white flex items-center justify-center font-bold text-sm cursor-pointer">
                <span id="nav-avatar">U</span>
            </div>
        </div>
    </nav>

    <div class="flex-1 overflow-hidden">
        <div class="h-full w-full max-w-[1600px] mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

            <aside class="lg:col-span-4 xl:col-span-3 h-full overflow-y-auto lg:overflow-hidden flex flex-col gap-4">
                
                <div class="glass-panel rounded-2xl overflow-hidden relative flex-shrink-0">
                    <div class="h-32 bg-gradient-to-r from-blue-500 via-brand to-purple-500"></div>
                    
                    <div class="px-6 pb-6 text-center relative">
                        <div class="w-28 h-28 rounded-full border-4 border-white bg-white mx-auto -mt-14 shadow-md flex items-center justify-center overflow-hidden">
                            <span id="profile-avatar-text" class="text-4xl font-bold text-gray-400">?</span>
                            <img id="profile-img-tag" class="hidden w-full h-full object-cover"> 
                        </div>

                        <div class="mt-3">
                            <h2 id="profile-name" class="text-2xl font-bold text-gray-900">Loading User...</h2>
                            <p id="profile-headline" class="text-gray-500 text-sm mt-1">Student at SkillXchange</p>
                            <div class="flex items-center justify-center gap-2 mt-2 text-xs text-gray-400 font-medium uppercase tracking-wide">
                                <i class="fas fa-map-marker-alt text-brand"></i> <span id="profile-location">India</span>
                            </div>
                        </div>

                        <div class="mt-6 flex gap-3">
                            <a id="btn-github" href="#" target="_blank" class="flex-1 flex items-center justify-center gap-2 bg-gray-900 text-white py-2.5 rounded-xl font-medium hover:opacity-90 transition shadow-lg shadow-gray-200">
                                <i class="fab fa-github text-lg"></i> GitHub
                            </a>
                            <a id="btn-email" href="#" class="w-12 flex items-center justify-center bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition">
                                <i class="fas fa-envelope text-lg"></i>
                            </a>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 p-4 bg-gray-50/50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-lg shadow-sm border border-gray-100 flex items-center justify-center text-brand text-lg">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-xs font-bold text-gray-400 uppercase">Education</h4>
                                <p id="profile-uni" class="text-sm font-semibold text-gray-800 truncate w-48">University Not Set</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 flex-1 lg:hidden">
                    <h3 class="font-bold text-gray-900 mb-2">About</h3>
                    <p id="profile-bio-mobile" class="text-gray-600 text-sm leading-relaxed">Loading bio...</p>
                </div>

            </aside>

            <main class="lg:col-span-8 xl:col-span-9 h-full overflow-y-auto pb-20 pr-1">
                
                <div class="glass-panel rounded-2xl p-6 mb-6 hidden lg:block">
                    <h3 class="font-bold text-lg text-gray-900 mb-3 flex items-center gap-2">
                        <i class="far fa-user-circle text-brand"></i> About Me
                    </h3>
                    <p id="profile-bio" class="text-gray-600 leading-7">
                        No bio added yet. Click 'Edit Profile' to introduce yourself!
                    </p>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                            <i class="fas fa-rss text-brand"></i> Recent Activity
                        </h3>
                    </div>

                    <div id="posts-container" class="flex overflow-x-auto gap-4 pb-4 snap-x-mandatory no-scrollbar">
                        <div class="w-full text-center py-10 bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                            Loading posts...
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-gray-900 flex items-center gap-2">
                            <i class="fas fa-layer-group text-brand"></i> Projects
                        </h3>
                        <a href="index.html" class="text-sm font-semibold text-brand hover:underline">+ Add New</a>
                    </div>

                    <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                        <div class="col-span-full text-center py-10 bg-white rounded-2xl border border-dashed border-gray-300 text-gray-400">
                            Loading projects...
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-[100] backdrop-blur-sm p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform scale-100 transition-transform">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="font-bold text-gray-800">Edit Profile</h3>
                <button onclick="toggleEditModal()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">First Name</label>
                        <input id="edit-fname" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-brand outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Last Name</label>
                        <input id="edit-lname" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-brand outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">University / College</label>
                    <div class="relative">
                        <i class="fas fa-university absolute left-3 top-3 text-gray-400"></i>
                        <input id="edit-uni" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 pl-10 focus:ring-2 focus:ring-brand outline-none" placeholder="e.g. Stanford University">
                    </div>
                </div>
                <div>
  <label class="block text-xs font-bold text-gray-500 uppercase mb-1">
    Headline
  </label>
  <input
    id="edit-headline"
    type="text"
    class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 focus:ring-2 focus:ring-brand outline-none"
    placeholder="e.g. CS Student | Full-stack Developer"
  />
</div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">GitHub Username / URL</label>
                    <div class="relative">
                        <i class="fab fa-github absolute left-3 top-3 text-gray-400"></i>
                        <input id="edit-github" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 pl-10 focus:ring-2 focus:ring-brand outline-none" placeholder="github.com/username">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bio</label>
                    <textarea id="edit-bio" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 h-24 resize-none focus:ring-2 focus:ring-brand outline-none" placeholder="Tell us about yourself..."></textarea>
                </div>
                <button onclick="saveProfile()" class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition shadow-lg shadow-indigo-200 mt-2">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLafxMmbSanvmgP9KPvWXO7968BgkSMAQ",
            authDomain: "skillxchange-93fac.firebaseapp.com",
            projectId: "skillxchange-93fac",
            storageBucket: "skillxchange-93fac.firebasestorage.app",
            messagingSenderId: "363649168062",
            appId: "1:363649168062:web:a938e95d8c7a684a1de4ef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;
// üîπ read profile uid from URL (if exists)
const params = new URLSearchParams(window.location.search);
const profileUid = params.get("uid"); // null if not provided

        // 2. LOAD DATA
        auth.onAuthStateChanged(async (user) => {

    // ‚ùå no login and no profile uid
    if (!user && !profileUid) {
        window.location.href = "login.html";
        return;
    }

    // üîë decide whose profile to load
    let uidToLoad = profileUid || user.uid;

    // store logged-in user separately
    currentUser = user || null;

    // Check if profileUid is a username (not a UID), and look it up
    if (profileUid && profileUid.length < 20 && !profileUid.includes("@")) {
        // Likely a username, search for it
        const userQuery = await db.collection("users")
            .where("firstName", "==", profileUid.split(" ")[0])
            .limit(1)
            .get();
        
        if (!userQuery.empty) {
            uidToLoad = userQuery.docs[0].id;
        } else {
            // Try to search by full name in a different way
            const allUsers = await db.collection("users").get();
            let foundUser = null;
            allUsers.forEach(doc => {
                const userData = doc.data();
                const fullName = `${userData.firstName || ""} ${userData.lastName || ""}`.trim();
                if (fullName === profileUid) {
                    foundUser = doc.id;
                }
            });
            
            if (foundUser) {
                uidToLoad = foundUser;
            } else {
                alert("User profile not found");
                window.location.href = "index.html";
                return;
            }
        }
    }

    const doc = await db.collection("users").doc(uidToLoad).get();
    if (!doc.exists) {
        alert("User profile not found");
        window.location.href = "index.html";
        return;
    }

    const data = doc.data();

    // update profile UI
    updateUI(data, user?.email || "");

    // load posts & projects ONLY for owner
    if (!profileUid || profileUid === user?.uid || uidToLoad === user?.uid) {
        loadPosts();
        loadProjects(`${data.firstName} ${data.lastName}`);
    } else {
        // hide edit button when viewing others
        document.querySelector("button[onclick='toggleEditModal()']").style.display = "none";
    }
});


        function updateUI(data, email) {
            const fullName = `${data.firstName} ${data.lastName}`;
            const initial = data.firstName.charAt(0);
            const headlineEl = document.getElementById("profile-headline");

if (data.headline && data.headline.trim() !== "") {
  headlineEl.innerText = data.headline;
  headlineEl.style.display = "block";
} else {
  headlineEl.style.display = "none";
}
            // Text Updates
            document.getElementById("profile-name").innerText = fullName;
            document.getElementById("profile-headline").innerText = data.headline || "Student at SkillXchange"; // Fallback
            document.getElementById("profile-uni").innerText = data.university || "University not listed";
            document.getElementById("profile-avatar-text").innerText = initial;
            document.getElementById("nav-avatar").innerText = initial;
            document.getElementById("profile-bio").innerText = data.bio || "No bio added yet.";
            document.getElementById("profile-bio-mobile").innerText = data.bio || "No bio added yet.";

            // Links
            let ghLink = data.githubLink || "#";
            if(ghLink !== "#" && !ghLink.startsWith("http")) ghLink = "https://" + ghLink;
            
            document.getElementById("btn-github").href = ghLink;
            document.getElementById("btn-email").href = `mailto:${email}`;

            // Fill Edit Modal
            document.getElementById("edit-fname").value = data.firstName;
            document.getElementById("edit-lname").value = data.lastName;
            document.getElementById("edit-uni").value = data.university || "";
            document.getElementById("edit-bio").value = data.bio || "";
            document.getElementById("edit-github").value = data.githubLink || "";
            document.getElementById("edit-headline").value = data.headline || "";

        }

       function loadPosts() {
  const container = document.getElementById("posts-container");

  if (!currentUser) {
    container.innerHTML = `<p class="text-gray-400">Not logged in</p>`;
    return;
  }

  db.collection("questions")
    .where("uid", "==", currentUser.uid) // üî• SAFE QUERY
    .get()
    .then(snapshot => {
      container.innerHTML = "";

      if (snapshot.empty) {
        container.innerHTML = `
          <div class="text-gray-400 italic">
            No posts yet.
          </div>`;
        return;
      }

      snapshot.forEach(doc => {
        const post = doc.data();
        container.innerHTML += `
          <div class="snap-center shrink-0 w-80 bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
            <span class="text-xs text-gray-400">${post.tag}</span>
            <h4 class="font-bold text-gray-800 mt-1">
              ${post.title}
            </h4>
            <div class="mt-3 text-xs text-brand font-semibold">
              ‚ù§Ô∏è ${post.likes || 0} Likes
            </div>
          </div>
        `;
      });
    })
    .catch(err => {
      console.error("Post load failed:", err);
      container.innerHTML = `
        <p class="text-red-500 text-sm">
          Failed to load posts. Check console.
        </p>`;
    });
}



        function loadProjects(username) {
            const grid = document.getElementById("projects-grid");
            db.collection("projects")
                .where("author", "==", username)
                .get()
                .then(snap => {
                    grid.innerHTML = "";
                    if (snap.empty) {
                        grid.innerHTML = `<div class="col-span-full p-6 text-center text-gray-400 border border-dashed rounded-xl">No projects found.</div>`;
                        return;
                    }
                    snap.forEach(doc => {
                        const p = doc.data();
                        grid.innerHTML += `
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition group">
                            <div class="h-24 bg-gray-100 flex items-center justify-center group-hover:bg-brandLight transition">
                                <i class="fas fa-laptop-code text-3xl text-gray-300 group-hover:text-brand"></i>
                            </div>
                            <div class="p-5">
                                <h3 class="font-bold text-gray-900 mb-1 truncate">${p.title}</h3>
                                <p class="text-xs text-gray-500 line-clamp-2 h-8 mb-3">${p.description}</p>
                                <div class="flex flex-wrap gap-1">
                                    <span class="px-2 py-1 bg-gray-50 text-gray-500 text-[10px] rounded border border-gray-100">${p.techStack || 'Tech'}</span>
                                </div>
                            </div>
                        </div>`;
                    });
                });
        }

        function toggleEditModal() {
            const m = document.getElementById("edit-modal");
            m.classList.toggle("hidden");
            m.classList.toggle("flex");
        }

        function saveProfile() {
            if (!currentUser) return;
            const updates = {
                firstName: document.getElementById("edit-fname").value,
                lastName: document.getElementById("edit-lname").value,
                university: document.getElementById("edit-uni").value,
                bio: document.getElementById("edit-bio").value,
                githubLink: document.getElementById("edit-github").value,
                headline: document.getElementById("edit-headline").value
            };

            db.collection("users").doc(currentUser.uid).update(updates).then(() => {
                alert("Saved!");
                location.reload();
            });
        }


        // Call loadBondHistory after auth state is loaded
        auth.onAuthStateChanged((user) => {
            if (user || params.get("uid")) {
                // Bond history is now in index.html - Bond History menu item
            }
        });
    </script>
</body>
</html>