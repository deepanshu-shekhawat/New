<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer2Skill - Student Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: '#6366f1',
                        brandDark: '#4f46e5',
                        brandLight: '#e0e7ff',
                        glassBorder: 'rgba(255, 255, 255, 0.2)',
                        glassBorderDark: 'rgba(255, 255, 255, 0.05)',
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'glass-sm': '0 2px 10px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern Gradient Background */
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #eef2ff 100%);
            background-attachment: fixed;
        }
        html.dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        html.dark .glass-panel {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.85);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        html.dark .glass-card {
            background: rgba(31, 41, 55, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        html.dark .glass-card:hover {
            background: rgba(31, 41, 55, 0.7);
        }

        /* Sidebar Links */
        .sidebar-link { transition: all 0.2s; border-radius: 12px; margin-bottom: 6px; }
        .sidebar-link:hover { background-color: rgba(99, 102, 241, 0.1); color: #4f46e5; }
        html.dark .sidebar-link:hover { background-color: rgba(99, 102, 241, 0.2); color: #818cf8; }
        
        .sidebar-link.active { 
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), transparent);
            color: #4f46e5; 
            font-weight: 600; 
            border-left: 3px solid #6366f1;
            border-radius: 4px 12px 12px 4px;
        }
        html.dark .sidebar-link.active { 
            color: #818cf8; 
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.25), transparent);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }

        .page-section { display: none; height: 100%; animation: fadeSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .page-section.active-page { display: block; }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chat-room-item { cursor: pointer; border-radius: 12px; transition: all 0.2s; border: 1px solid transparent; }
        .chat-room-item:hover { background-color: rgba(0,0,0,0.03); }
        html.dark .chat-room-item:hover { background-color: rgba(255,255,255,0.05); }
        
        .chat-room-item.active { background-color: rgba(99, 102, 241, 0.1); color: #4f46e5; font-weight: 600; border-color: rgba(99, 102, 241, 0.2); }
        html.dark .chat-room-item.active { background-color: rgba(99, 102, 241, 0.2); color: #818cf8; }

        /* Sort Filter Buttons */
        .sort-filter-btn {
            background-color: white;
            color: #606e8a;
            border-color: #e5e7eb;
            cursor: pointer;
        }
        .sort-filter-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
            background-color: #f0f4ff;
        }
        .sort-filter-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        html.dark .sort-filter-btn {
            background-color: rgba(31, 41, 55, 0.5);
            color: #9ca3af;
            border-color: #4b5563;
        }
        html.dark .sort-filter-btn:hover {
            border-color: #818cf8;
            color: #818cf8;
            background-color: rgba(99, 102, 241, 0.2);
        }
        html.dark .sort-filter-btn.active {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            color: white;
            border-color: #818cf8;
        }

        /* Skill Input Tags */
        .skill-input-container {
            transition: all 0.2s ease;
            cursor: text;
        }
        .skill-input-container:focus-within {
            background-color: rgba(255, 255, 255, 0.8);
            border-color: #6366f1;
        }
        html.dark .skill-input-container:focus-within {
            background-color: rgba(99, 102, 241, 0.15);
            border-color: #818cf8;
        }
        
        .skill-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            animation: slideIn 0.2s ease-out;
        }
        
        .skill-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            font-size: 14px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        
        .skill-tag button:hover {
            opacity: 1;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Message Action Menu Styling */
        .message-action-menu {
            animation: slideIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 180px;
        }

        .message-bubble {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            word-wrap: break-word;
            word-break: break-word;
        }
            }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-700 dark:text-gray-200 font-sans">

    <aside class="w-72 glass-panel border-r-0 flex flex-col z-30 hidden md:flex shrink-0 transition-colors duration-300 relative">
        <div class="h-20 flex items-center px-6">
            <img src="https://well-amaranth-cme9t22olq.edgeone.app/WhatsApp_Image_2026-02-21_at_01.39.34-removebg-preview.png" alt="Peer2Skill Logo" class="h-12 w-auto object-contain mr-3">
            <span class="font-bold text-xl tracking-tight text-gray-800 dark:text-white">Peer2Skill</span>
        </div>

        <div class="flex-1 overflow-y-auto py-6 px-5 space-y-8">
            <div>
                <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Menu</p>
                <nav class="space-y-1">
                    <div onclick="switchPage('explore', this)" class="sidebar-link active flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-compass w-6 text-center mr-3 text-lg"></i> Explore Feed
                    </div>
                    <div onclick="switchPage('projects', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-layer-group w-6 text-center mr-3 text-lg"></i> Projects
                    </div>
                    <div onclick="switchPage('seniors', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-graduation-cap w-6 text-center mr-3 text-lg"></i> Community
                    </div>
                    <div onclick="switchPage('hackrooms', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
  <i class="fas fa-laptop-code w-6 text-center mr-3 text-lg"></i> HackRooms
</div>
                    <div onclick="switchPage('skill-matches', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-handshake w-6 text-center mr-3 text-lg"></i> Skill Matches
                    </div>
                    <div onclick="switchPage('bond-requests', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-bell w-6 text-center mr-3 text-lg"></i> Bond Requests
                        <span class="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden shadow-red-500/50" id="bond-req-badge"></span>
                    </div>

                </nav>
            </div>

            <div>
                <p class="px-3 text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Personal</p>
                <nav class="space-y-1">
                    <div onclick="switchPage('chat', this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-comments w-6 text-center mr-3 text-lg"></i> Messages
                        <span class="ml-auto bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden shadow-red-500/50" id="msg-badge"></span>
                    </div>
                    <div onclick="openMyPosts(this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-pencil-alt w-6 text-center mr-3 text-lg"></i> My Posts
                    </div>
                    <div onclick="openMyProjects(this)" class="sidebar-link flex items-center px-4 py-3 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                        <i class="fas fa-folder-open w-6 text-center mr-3 text-lg"></i> My Projects
                    </div>
                </nav>
            </div>
        </div>

        <div class="p-5 border-t border-gray-200/40 dark:border-gray-700/40">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 text-white flex items-center justify-center font-bold text-sm shadow-md">G</div>
              <div class="ml-3">
               <p id="user-name-display" class="text-sm font-semibold text-gray-800 dark:text-white hidden"></p>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Online</p>
                </div>
              </div>
            </div>
            <button id="sidebar-logout-btn" onclick="logout()" class="text-xs text-red-500 font-semibold hidden hover:bg-red-50 dark:hover:bg-red-900/20 px-2 py-1 rounded transition">Logout</button>
          </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <header class="h-20 glass-panel border-b-0 border-l border-white/40 dark:border-gray-700/30 flex items-center justify-between px-8 z-20 shrink-0 sticky top-0">
            <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-900 to-gray-600 dark:from-white dark:to-gray-300" id="header-title">Explore Feed</h2>

            <div class="flex items-center space-x-5">
              <button onclick="window.location.href='code-visualizer.html'" class="text-sm font-semibold text-white bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-full transition shadow-lg hidden sm:inline-flex items-center gap-2">
                <i class="fas fa-play-circle"></i> Code Visualizer
              </button>
              <button onclick="window.location.href='live-editor.html'" class="text-sm font-semibold text-white bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-full transition shadow-lg hidden sm:inline-flex">Live Editor</button>

              <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-gray-100/50 dark:bg-gray-700/50 backdrop-blur-sm border border-gray-200/50 dark:border-gray-600/50 flex items-center justify-center text-gray-600 dark:text-yellow-400 transition hover:bg-white dark:hover:bg-gray-600 hover:shadow-md">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
              </button>

              <div class="relative hidden md:block">
                    <div class="flex items-center w-72 px-4 py-2.5 bg-white/40 dark:bg-gray-800/40 border border-gray-200/60 dark:border-gray-600/60 rounded-full focus-within:ring-2 focus-within:ring-brand/50 focus-within:bg-white/70 dark:focus-within:bg-gray-800/70 transition-all shadow-sm backdrop-blur-sm">
                        <i class="fas fa-search mr-3 text-gray-400"></i>
                        <input 
                            type="text" 
                            id="search-input" 
                            onkeyup="handleSearch()" 
                            placeholder="Search..." 
                            class="bg-transparent border-none text-sm text-gray-700 dark:text-gray-200 placeholder-gray-400 focus:outline-none w-full"
                        >
                        <kbd class="hidden sm:inline-block px-2 py-0.5 text-[10px] font-bold text-gray-500 bg-gray-200/50 dark:bg-gray-600/50 rounded border border-gray-300/30">/</kbd>
                    </div>
                </div>

                <div class="flex items-center space-x-3 pl-4" id="header-auth-section">
                  <button onclick="window.location.href='login.html'" class="text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-brand transition">Log in</button>
                  <button onclick="window.location.href='signup.html'" class="text-sm font-semibold text-white bg-brand hover:bg-brandDark px-5 py-2 rounded-full transition shadow-lg shadow-brand/30">Sign up</button>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-hidden relative">
            
            <div id="explore" class="page-section active-page overflow-y-auto p-6 md:p-8">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 max-w-7xl mx-auto">
                    
                    <div class="hidden lg:block lg:col-span-1 space-y-6">
                        <div class="glass-card rounded-2xl overflow-hidden sticky top-4">
                            <div class="p-4 border-b border-gray-100 dark:border-gray-700/50 flex justify-between items-center bg-gray-50/30 dark:bg-white/5">
                                <span class="text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wide">GitHub Repos</span>
                                <i class="fab fa-github text-gray-700 dark:text-gray-300 text-lg"></i>
                            </div>
                            <div id="github-repo-list" class="flex flex-col min-h-[100px]">
                                <p class="text-center text-gray-400 text-xs py-6">Loading repositories...</p>
                            </div>
                            <a id="github-profile-link" href="#" target="_blank" class="block p-3 text-center border-t border-gray-100 dark:border-gray-700/50 bg-gray-50/30 dark:bg-white/5 hover:bg-gray-100/50 dark:hover:bg-white/10 cursor-pointer transition">
                                <span class="text-xs font-bold text-gray-600 dark:text-gray-300 flex items-center justify-center gap-2">
                                    View Profile <i class="fas fa-external-link-alt"></i>
                                </span>
                            </a>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass-card rounded-2xl p-4 flex items-center space-x-4 cursor-pointer group border border-brand/20 hover:border-brand/50 transition-colors" onclick="toggleModal('qa-modal')">
                            <div class="w-12 h-12 rounded-full bg-gray-100/80 dark:bg-gray-700/80 flex items-center justify-center text-gray-500 group-hover:bg-brandLight group-hover:text-brand transition"><i class="fas fa-pen"></i></div>
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium">Ask a question or share an idea...</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 pb-2">
                            <button onclick="filterPostsByTag('all')" class="sort-filter-btn active px-4 py-2 rounded-full text-sm font-semibold transition-all border" data-tag="all">
                                <i class="fas fa-square-poll-vertical mr-2"></i> All Posts
                            </button>
                            <button onclick="filterPostsByTag('Offering Skill')" class="sort-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-all border" data-tag="Offering Skill">
                                <i class="fas fa-gift mr-2"></i> Offering Skills
                            </button>
                            <button onclick="filterPostsByTag('Help Needed')" class="sort-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-all border" data-tag="Help Needed">
                                <i class="fas fa-hand-holding-heart mr-2"></i> Help Needed
                            </button>
                            <button onclick="filterPostsByTag('Project Idea')" class="sort-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-all border" data-tag="Project Idea">
                                <i class="fas fa-lightbulb mr-2"></i> Project Ideas
                            </button>
                            <button onclick="filterPostsByTag('General')" class="sort-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-all border" data-tag="General">
                                <i class="fas fa-comments mr-2"></i> General
                            </button>
                        </div>
                        
                        <div id="qa-container" class="space-y-6 pb-10">
                            <p class="text-center text-gray-400 py-10 animate-pulse">Loading community posts...</p>
                        </div>
                    </div>

                    <div class="hidden lg:block lg:col-span-1 space-y-6">
                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm uppercase tracking-wide">Trending Tags</h3>
                            <div class="flex flex-wrap gap-2">
                                <span class="px-3 py-1 bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-full text-xs font-medium text-gray-600 dark:text-gray-300 hover:border-brand hover:text-brand cursor-pointer transition">#Python</span>
                                <span class="px-3 py-1 bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-full text-xs font-medium text-gray-600 dark:text-gray-300 hover:border-brand hover:text-brand cursor-pointer transition">#ReactJS</span>
                                <span class="px-3 py-1 bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-full text-xs font-medium text-gray-600 dark:text-gray-300 hover:border-brand hover:text-brand cursor-pointer transition">#Internships</span>
                            </div>
                        </div>

                        <div class="glass-card rounded-2xl p-6">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm uppercase tracking-wide flex items-center gap-2">
                                <i class="fas fa-search text-brand"></i>Keyword Search
                            </h3>
                            <div class="space-y-3">
                                <input type="text" 
                                       id="keyword-search-offering" 
                                       placeholder="Search skills (e.g., Python, Design)..." 
                                       class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm text-sm"
                                       oninput="performKeywordSearch()">
                                <div id="keyword-search-results" class="space-y-2 max-h-64 overflow-y-auto">
                                    <p class="text-xs text-gray-400 text-center py-4">Enter a skill to search</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           <div id="projects" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                  <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Student Projects</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Collaborate on ongoing projects or showcase yours.</p>
                  </div>
                  <button onclick="toggleModal('project-modal')" class="bg-brand text-white px-6 py-2.5 rounded-full font-semibold hover:bg-brandDark transition shadow-lg shadow-brand/30 flex items-center gap-2">
                    <i class="fas fa-plus"></i> Launch Project
                  </button>
                </div>
                <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
              </div>
            </div>

            <div id="my-projects" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">My Projects</h1>
                  <p class="text-gray-500 dark:text-gray-400 mt-1">Manage the projects you have published.</p>
                </div>
                <div id="my-projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  <p class="text-gray-400 col-span-full text-center py-10">Loading your projects...</p>
                </div>
              </div>
            </div>

            <div id="my-posts" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-4xl mx-auto">
                <div class="mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">My Posts</h1>
                  <p class="text-gray-500 dark:text-gray-400 mt-1">Manage your community contributions.</p>
                </div>
                <div id="my-posts-container" class="space-y-6">
                  <p class="text-gray-400 text-center py-10">Loading your posts...</p>
                </div>
              </div>
            </div>

            <div id="seniors" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-end mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Community Members</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Connect with peers and alumni.</p>
                  </div>
                </div>
                <div id="seniors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  <p class="text-gray-400 text-center col-span-full py-10">Loading profiles...</p>
                </div>
              </div>
            </div>
            <div id="hackrooms" class="page-section overflow-y-auto h-full p-6 md:p-8">
  <div class="max-w-7xl mx-auto">
    
    <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">
          HackRooms
        </h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1">
          Find or build a hackathon team.
        </p>
      </div>

      <button onclick="toggleModal('hackroom-modal')"
        class="bg-brand text-white px-6 py-2.5 rounded-full font-semibold hover:bg-brandDark transition shadow-lg shadow-brand/30 flex items-center gap-2">
        <i class="fas fa-plus"></i> Launch HackRoom
      </button>
    </div>

    <div id="hackrooms-container"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    </div>

  </div>
</div>

            <div id="skill-matches" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Skill Matches</h1>
                  <p class="text-gray-500 dark:text-gray-400 mt-1">Find students to exchange skills with based on matching keywords.</p>
                </div>

                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-gray-600 dark:text-gray-300 uppercase mb-2">Search by Skill to Offer</label>
                    <input type="text" id="match-search-offer" placeholder="e.g., Python, Web Design..." class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm" oninput="filterMatches()">
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-gray-600 dark:text-gray-300 uppercase mb-2">Search by Skill to Learn</label>
                    <input type="text" id="match-search-learn" placeholder="e.g., React, Photography..." class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm" oninput="filterMatches()">
                  </div>
                </div>

                <div id="skill-matches-container" class="space-y-6">
                  <p class="text-center text-gray-400 py-10 animate-pulse">Loading skill matches...</p>
                </div>
              </div>
            </div>

            <div id="bond-requests" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Bond Requests</h1>
                  <p class="text-gray-500 dark:text-gray-400 mt-1">Manage incoming and outgoing bond requests.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                      <i class="fas fa-inbox text-brand"></i>Incoming Requests
                    </h2>
                    <div id="incoming-requests" class="space-y-3">
                      <p class="text-center text-gray-400 py-10 animate-pulse">Loading incoming requests...</p>
                    </div>
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                      <i class="fas fa-paper-plane text-brand"></i>Outgoing Requests
                    </h2>
                    <div id="outgoing-requests" class="space-y-3">
                      <p class="text-center text-gray-400 py-10 animate-pulse">Loading outgoing requests...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="bond-history" class="page-section overflow-y-auto h-full p-6 md:p-8">
              <div class="max-w-7xl mx-auto">
                <div class="mb-8 border-b border-gray-200/50 dark:border-gray-700/50 pb-4">
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">Bond History</h1>
                  <p class="text-gray-500 dark:text-gray-400 mt-1">Track all your active and completed skill exchanges.</p>
                </div>

                <div id="bond-history-container" class="space-y-4">
                  <p class="text-center text-gray-400 py-10 animate-pulse">Loading bond history...</p>
                </div>
              </div>
            </div>

            <div id="shared-bond" class="page-section overflow-y-auto h-full p-6 md:p-8 hidden">
              <div class="max-w-7xl mx-auto">
                <div class="mb-8 flex justify-between items-center">
                  <div class="border-b border-gray-200/50 dark:border-gray-700/50 pb-4 flex-1">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight" id="bond-title">Skill Exchange</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1" id="bond-subtitle">Active skill exchange session</p>
                  </div>
                  <button onclick="closeBondInterface()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition text-2xl">‚úï</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                  <!-- User Info -->
                  <div class="lg:col-span-1">
                    <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl">
                      <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white">Your Bond Partner</h3>
                      <div class="flex items-center gap-4 mb-6">
                        <div id="bond-partner-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center font-bold text-xl">P</div>
                        <div>
                          <p id="bond-partner-name" class="font-bold text-gray-900 dark:text-white">Partner Name</p>
                          <p id="bond-partner-role" class="text-xs text-gray-400">Role</p>
                        </div>
                      </div>

                      <div class="space-y-3 mb-6">
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-800">
                          <p class="text-xs font-bold text-green-700 dark:text-green-300 mb-1">Teaching You:</p>
                          <p id="bond-skill-offered" class="text-sm font-semibold text-green-900 dark:text-green-100">Skill</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                          <p class="text-xs font-bold text-blue-700 dark:text-blue-300 mb-1">You're Learning:</p>
                          <p id="bond-skill-learned" class="text-sm font-semibold text-blue-900 dark:text-blue-100">Skill</p>
                        </div>
                      </div>

                      <div class="flex gap-2">
                        <button onclick="openBondChat()" class="flex-1 bg-brand text-white px-3 py-2 rounded-lg font-semibold hover:bg-brandDark transition text-sm">
                          <i class="fas fa-message mr-2"></i>Message
                        </button>
                        <button id="bond-break-btn" onclick="breakBondFromInterface()" class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm">
                          <i class="fas fa-ban mr-2"></i>End Bond
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Progress & Assessment -->
                  <div class="lg:col-span-2 space-y-6">
                    <!-- Progress Tracker -->
                    <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl">
                      <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="fas fa-chart-line text-brand"></i> Progress
                      </h3>
                      <div class="space-y-4">
                        <div>
                          <div class="flex justify-between items-center mb-2">
                            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Bond Duration</p>
                            <p id="bond-duration" class="text-xs text-gray-500">0 days active</p>
                          </div>
                          <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div id="bond-progress-bar" class="h-full bg-gradient-to-r from-brand to-purple-500 rounded-full" style="width: 35%"></div>
                          </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Active skill exchange sessions: <span id="bond-session-count" class="font-bold">0</span></p>
                      </div>
                    </div>

                    <!-- Assessment Section -->
                    <div id="assessment-section" class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl">
                      <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-orange-500"></i> Assessment
                      </h3>
                      <div id="assessment-content">
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Tutor assessment of learner's progress will appear here.</p>
                        <button id="submit-assessment-btn" onclick="showAssessmentForm()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                          <i class="fas fa-plus mr-2"></i>Add Assessment
                        </button>
                      </div>
                    </div>

                    <!-- Feedback Section -->
                    <div id="feedback-section" class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl">
                      <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="fas fa-star text-yellow-500"></i> Feedback
                      </h3>
                      <div id="feedback-content">
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">Feedback and ratings will appear here once the bond is completed.</p>
                        <button id="submit-feedback-btn" onclick="showFeedbackForm()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold transition text-sm">
                          <i class="fas fa-pencil mr-2"></i>Add Feedback
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Bond Status -->
                <div id="bond-status-card" class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl mb-6">
                  <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white">Bond Status</h3>
                  <div class="flex items-center justify-between">
                    <div>
                      <p id="bond-status-text" class="text-2xl font-bold text-green-600 dark:text-green-400">üü¢ Active</p>
                      <p id="bond-created-date" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Created on --</p>
                    </div>
                    <div class="text-right">
                      <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold mb-2">Bond ID</p>
                      <p id="bond-id" class="text-sm font-mono text-gray-600 dark:text-gray-300 break-all">---</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="chat" class="page-section h-full">
                <div class="flex h-full glass-panel border-0 m-0 md:m-4 md:rounded-2xl overflow-hidden shadow-2xl">
                    <div class="w-80 bg-white/60 dark:bg-gray-800/60 border-r border-gray-200/50 dark:border-gray-700/50 flex flex-col h-full backdrop-blur-md">
                        <div class="p-5 border-b border-gray-200/50 dark:border-gray-700/50">
                            <h3 class="font-bold text-gray-800 dark:text-gray-200 text-sm uppercase tracking-wide">Conversations</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-3 space-y-6">
                            <div>
                                <h4 class="px-3 text-xs font-bold text-gray-400 uppercase mb-3">Groups</h4>
                                <div class="space-y-1">
                                    <div onclick="switchRoom('general', 'General Chat')" id="room-general" class="chat-room-item active flex items-center px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                                        <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center mr-3 text-indigo-500"><i class="fas fa-hashtag"></i></div>
                                        General
                                    </div>
                                    <div onclick="switchRoom('projects', 'ONLY STUDENTS GROUP')" id="room-projects" class="chat-room-item flex items-center px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                                        <div class="w-8 h-8 rounded-lg bg-pink-100 dark:bg-pink-900/50 flex items-center justify-center mr-3 text-pink-500"><i class="fas fa-users"></i></div>
                                        Vrians
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="px-3 text-xs font-bold text-gray-400 uppercase mb-3 flex justify-between">Direct Messages</h4>
                                <div class="space-y-1" id="dm-list">
                                    <p class="text-xs text-gray-400 px-4 italic" id="no-dms-msg">No recent messages</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white/40 dark:bg-gray-900/40 backdrop-blur-sm relative">
                        <div class="h-16 border-b border-gray-200/50 dark:border-gray-700/50 flex items-center px-6 justify-between bg-white/60 dark:bg-gray-800/60 backdrop-blur-md shrink-0">
                            <div class="flex items-center">
                                <div class="w-9 h-9 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center mr-3 text-gray-500 dark:text-gray-300 shadow-sm">
                                    <i class="fas fa-hashtag" id="chat-header-icon"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 dark:text-white text-sm" id="chat-header-name">General Chat</h3>
                                    <p class="text-[10px] text-green-500 font-semibold uppercase tracking-wider">‚óè Online</p>
                                </div>
                            </div>
                            <button id="delete-chat-btn" onclick="deleteCurrentChat()" class="text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition hidden">
                                <i class="fas fa-trash-alt text-lg"></i>
                            </button>
                        </div>
                        <div id="chat-messages" class="flex-1 p-6 overflow-y-auto space-y-4">
                            </div>
                        <div class="p-4 bg-white/70 dark:bg-gray-800/70 border-t border-gray-200/50 dark:border-gray-700/50 flex items-center backdrop-blur-md">
                            <button class="text-gray-400 hover:text-brand mr-3 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="fas fa-paperclip text-lg"></i></button>
                            <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 border border-gray-200 dark:border-gray-600 rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition bg-white dark:bg-gray-700/50 dark:text-white shadow-sm" onkeypress="if(event.key==='Enter') sendChat()">
                            <button onclick="sendChat()" class="ml-3 bg-brand text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-brandDark transition shadow-lg shadow-brand/30"><i class="fas fa-paper-plane text-sm"></i></button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="qa-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-md hidden items-center justify-center z-50 p-4 transition-all duration-300 overflow-y-auto">
        <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-100 overflow-hidden border border-white/20 my-8">
            <div class="bg-gray-50/50 dark:bg-gray-700/50 px-6 py-4 border-b border-gray-100 dark:border-gray-600 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">Create New Post</h3>
                <button onclick="toggleModal('qa-modal')" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-black/5 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-5 max-h-[70vh] overflow-y-auto">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Tag</label>
                    <select id="qa-tag" onchange="updateFormFields()" class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm">
                        <option value="Help Needed">Help Needed</option>
                        <option value="Offering Skill">Offering Skill</option>
                        <option value="Project Idea">Project Idea</option>
                        <option value="General">General</option>
                    </select>
                </div>

                <!-- Default Form Fields -->
                <div id="default-fields">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">What's on your mind?</label>
                        <textarea id="qa-title" class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-4 h-32 focus:ring-2 focus:ring-brand focus:border-transparent outline-none resize-none shadow-inner" placeholder="Ask a question, share a project idea, or offer help..."></textarea>
                    </div>
                </div>

                <!-- Offering Skill Form Fields -->
                <div id="offering-fields" class="hidden space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Skills to Offer</label>
                        <div id="skills-offer-container" class="skill-input-container w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl p-3 focus:within:ring-2 focus:within:ring-brand shadow-inner">
                            <div id="skills-offer-tags" class="flex flex-wrap gap-2 mb-2"></div>
                            <input type="text" id="skills-offer-input" placeholder="Type a skill and press Enter..." class="w-full bg-transparent outline-none dark:text-white text-sm" onkeydown="handleSkillInput(event, 'offer')">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Press Enter to add skills</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Skills to Learn</label>
                        <div id="skills-learn-container" class="skill-input-container w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl p-3 focus-within:ring-2 focus-within:ring-brand shadow-inner">
                            <div id="skills-learn-tags" class="flex flex-wrap gap-2 mb-2"></div>
                            <input type="text" id="skills-learn-input" placeholder="Type a skill and press Enter..." class="w-full bg-transparent outline-none dark:text-white text-sm" onkeydown="handleSkillInput(event, 'learn')">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Press Enter to add skills</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Course Description <span class="text-gray-400 text-[10px] font-normal">(Optional)</span></label>
                        <textarea id="course-description" class="w-full bg-white/50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 dark:text-white rounded-xl p-4 h-24 focus:ring-2 focus:ring-brand focus:border-transparent outline-none resize-none shadow-inner" placeholder="Describe the course, topics covered, experience required, teaching methodology, etc..."></textarea>
                    </div>
                </div>

                <button onclick="postQuestion()" class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition shadow-lg shadow-brand/30 mt-2">Post to Community</button>
            </div>
        </div>
    </div>

    <script>
      function goToAdmin() {
          sessionStorage.setItem("skipAdminRedirect", "true");
          window.location.href = "admin.html";
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        }

        function logout() {
          firebase.auth().signOut().then(() => {
            localStorage.clear();
            window.location.href = "home.html";
          });
        }

        function postProject() {
          const title = document.getElementById("proj-title").value.trim();
          const desc = document.getElementById("proj-desc").value.trim();
          const tech = document.getElementById("proj-tags").value.trim();
          const github = document.getElementById("proj-github").value.trim();
          
          const author = localStorage.getItem("sx_user");

          if (!author || author === "Guest") {
            alert("Please log in to post a project.");
            return;
          }
          if (!title || !desc) {
            alert("Title and description are required.");
            return;
          }

          const data = {
            title,
            description: desc,
            techStack: tech,
            githubLink: github,
            author,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (editingProjectId) {
            db.collection("projects").doc(editingProjectId).update(data).then(() => {
                editingProjectId = null;
                toggleModal("project-modal");
                loadMyProjects();
            });
            return;
          }

          db.collection("projects").add(data).then(() => {
            toggleModal("project-modal");
            loadMyProjects();
          });

          document.getElementById("proj-title").value = "";
          document.getElementById("proj-desc").value = "";
          document.getElementById("proj-tags").value = "";
          document.getElementById("proj-github").value = "";
        }

function postHackRoom() {
  const hackathon = document.getElementById("hack-hackathon").value.trim();
  const location = document.getElementById("hack-location").value.trim();
  const idea = document.getElementById("hack-idea").value.trim();
  const roles = document.getElementById("hack-roles").value.trim();
  const author = localStorage.getItem("sx_user");

  if (!author || author === "Guest") {
    alert("Please log in to launch a HackRoom.");
    return;
  }

  if (!hackathon || !idea) {
    alert("Hackathon name and project idea are required.");
    return;
  }

  db.collection("hackrooms").add({
    hackathon,
    location,
    idea,
    roles,
    author,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    toggleModal("hackroom-modal");
    loadHackRooms();
  });

  document.getElementById("hack-hackathon").value = "";
  document.getElementById("hack-location").value = "";
  document.getElementById("hack-idea").value = "";
  document.getElementById("hack-roles").value = "";
}


        const firebaseConfig = {
            apiKey: "AIzaSyCLafxMmbSanvmgP9KPvWXO7968BgkSMAQ",
            authDomain: "skillxchange-93fac.firebaseapp.com",
            projectId: "skillxchange-93fac",
            storageBucket: "skillxchange-93fac.firebasestorage.app",
            messagingSenderId: "363649168062",
            appId: "1:363649168062:web:a938e95d8c7a684a1de4ef"
        };

        let db;
        let currentRoomId = 'general';
        let currentRoomName = 'General Chat';
        let unsubscribeChat = null;

        if(firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            loadProjects();
            loadHackRooms();
            const auth = firebase.auth();

            auth.onAuthStateChanged(async (user) => {
              const authSection = document.getElementById("header-auth-section");
              const logoutBtn = document.getElementById("sidebar-logout-btn");
              const nameEl = document.getElementById("user-name-display");
              const avatarEl = document.getElementById("user-avatar");
              const uniEl = document.getElementById("card-user-university");
              const emailEl = document.getElementById("card-user-email");

              authSection.innerHTML = "";

              if (user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                if (!userDoc.exists) return;

                const userData = userDoc.data();
                const skip = sessionStorage.getItem("skipAdminRedirect");

                if (userData.isAdmin === true && !skip) {
                  window.location.href = "admin.html";
                  return;
                }

                sessionStorage.removeItem("skipAdminRedirect");

                const doc = await db.collection("users").doc(user.uid).get();
                if (!doc.exists) return;

                const data = doc.data();
                const fullName = `${data.firstName} ${data.lastName}`;
                const initial = fullName.charAt(0).toUpperCase();

                localStorage.setItem("sx_user", fullName);

                nameEl.classList.remove("hidden");
                avatarEl.classList.remove("hidden");
                updateUserUI(fullName);

                if (uniEl) uniEl.innerText = data.university || "University not set";
                if (emailEl) emailEl.innerText = user.email || "Email not available";

                const isAdmin = userData.isAdmin === true;

                authSection.innerHTML = `
                  <div class="relative">
                    <button onclick="toggleProfileMenu(event)" class="flex items-center space-x-3 hover:bg-white/50 dark:hover:bg-gray-700/50 px-3 py-1.5 rounded-full transition border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                      <div class="text-right hidden md:block">
                        <p class="text-sm font-bold text-gray-700 dark:text-gray-200">${fullName}</p>
                      </div>
                      <div class="w-9 h-9 rounded-full bg-gradient-to-br from-brand to-brandDark text-white flex items-center justify-center font-bold shadow-md">
                        ${initial}
                      </div>
                    </button>

                    <div id="profile-menu"
                         class="hidden absolute right-0 mt-3 w-56 glass-panel bg-white dark:bg-gray-800 rounded-xl shadow-xl z-50 overflow-hidden ring-1 ring-black ring-opacity-5">

                      <button onclick="window.location.href='profile.html'"
                              class="w-full flex items-center gap-3 px-5 py-3 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <i class="fas fa-user text-gray-500 w-5"></i>
                        <span>Profile</span>
                      </button>

                      ${
                        isAdmin
                          ? `
                        <button onclick="goToAdmin()"
                                class="w-full flex items-center gap-3 px-5 py-3 text-sm text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold transition">
                          <i class="fas fa-shield-alt w-5"></i>
                          <span>Admin Dashboard</span>
                        </button>
                        `
                          : ``
                      }

                      <hr class="border-gray-200 dark:border-gray-700/50">

                      <button onclick="logout()"
                              class="w-full flex items-center gap-3 px-5 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition">
                        <i class="fas fa-right-from-bracket w-5"></i>
                        <span>Sign Out</span>
                      </button>
                    </div>
                  </div>
                `;

                logoutBtn.classList.remove("hidden");
                loadGitHubRepos(data.githubLink);
                loadSavedDMs();
              } else {
                localStorage.removeItem("sx_user");
                nameEl.classList.remove("hidden");
                avatarEl.classList.remove("hidden");
                updateUserUI("Guest");
                if (uniEl) uniEl.innerText = "";
                if (emailEl) emailEl.innerText = "";

                authSection.innerHTML = `
                  <button onclick="location.href='login.html'" class="text-sm font-semibold text-gray-600 dark:text-gray-300 hover:text-brand">Log in</button>
                  <button onclick="location.href='signup.html'" class="text-sm font-semibold text-white bg-brand px-5 py-2 rounded-full shadow-md hover:bg-brandDark transition">Sign up</button>
                `;
                logoutBtn.classList.add("hidden");
              } 
            });

            function toggleLike(postId) {
              const currentUser = localStorage.getItem("sx_user");
              if (!currentUser || currentUser === "Guest") {
                alert("Please log in to like posts.");
                return;
              }
              const post = allPosts.find(p => p.id === postId);
              if (!post) return;
              if (!post.likedBy) post.likedBy = {};
              const ref = db.collection("questions").doc(postId);
              if (post.likedBy[currentUser]) {
                delete post.likedBy[currentUser];
                post.likes = Math.max((post.likes || 1) - 1, 0);
                renderFeed(allPosts);
                ref.update({
                  [`likedBy.${currentUser}`]: firebase.firestore.FieldValue.delete(),
                  likes: firebase.firestore.FieldValue.increment(-1)
                });
                return;
              }
              post.likedBy[currentUser] = true;
              post.likes = (post.likes || 0) + 1;
              renderFeed(allPosts);
              ref.update({
                [`likedBy.${currentUser}`]: true,
                likes: firebase.firestore.FieldValue.increment(1)
              });
            }

            // Delete post function with authorization and confirmation
            function deletePost(postId) {
              const currentUser = localStorage.getItem("sx_user");
              const post = allPosts.find(p => p.id === postId);

              if (!post) {
                alert("Post not found.");
                return;
              }

              // Authorization check - only post owner can delete
              if (post.author !== currentUser) {
                alert("You can only delete your own posts.");
                return;
              }

              // Confirmation dialog
              if (confirm(`Are you sure you want to delete this post? This action cannot be undone.`)) {
                db.collection("questions").doc(postId).delete().then(() => {
                  allPosts = allPosts.filter(p => p.id !== postId);
                  renderFeed(allPosts);
                  // Reload my posts if viewing that section
                  const myPostsContainer = document.getElementById("my-posts-container");
                  if (myPostsContainer && myPostsContainer.style.display !== "none") {
                    loadMyPosts();
                  }
                }).catch(error => {
                  alert("Error deleting post: " + error.message);
                });
              }
            }

            let allPosts = []; 
            db.collection("questions").orderBy("timestamp", "desc").onSnapshot(snap => {
                allPosts = []; 
                snap.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });
                renderFeed(allPosts); 
            });

            window.renderFeed = function(postsToRender) {
                const container = document.getElementById("qa-container");
                container.innerHTML = "";
                
                if(postsToRender.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-400 py-4">No posts found.</p>';
                    return;
                }

                postsToRender.forEach(data => {
                    const currentUser = localStorage.getItem("sx_user");
                    const hasLiked = data.likedBy && data.likedBy[currentUser];

                    const heartIcon = hasLiked
                      ? '<i class="fas fa-heart text-red-500 text-lg"></i>'
                      : '<i class="far fa-heart text-lg"></i>';

                    let tagColor = "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-600";
                    if(data.tag === "Help Needed") tagColor = "bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border-red-100 dark:border-red-800";
                    if(data.tag === "Offering Skill") tagColor = "bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 border-green-100 dark:border-green-800";
                    
                    let skillsHtml = '';
                    if(data.tag === "Offering Skill" && data.skillsToOffer) {
                      const skillsTags = (data.skillsToOffer || []).map(skill => 
                        `<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg text-xs font-medium">${skill}</span>`
                      ).join('');
                      skillsHtml = `
                        <div class="mt-4 space-y-2">
                          <p class="text-xs font-bold text-gray-600 dark:text-gray-400 uppercase">Teaching:</p>
                          <div class="flex flex-wrap gap-2">${skillsTags}</div>
                      `;
                      
                      if(data.skillsToLearn && data.skillsToLearn.length > 0) {
                        const learnTags = data.skillsToLearn.map(skill => 
                          `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-xs font-medium">${skill}</span>`
                        ).join('');
                        skillsHtml += `
                          <p class="text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mt-3">Interested in:</p>
                          <div class="flex flex-wrap gap-2">${learnTags}</div>
                        `;
                      }
                      
                      if(data.courseDescription) {
                        skillsHtml += `<p class="text-gray-700 dark:text-gray-300 text-sm mt-3 leading-relaxed">${data.courseDescription}</p>`;
                      }
                      skillsHtml += '</div>';
                    }

                    container.innerHTML += `
                        <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl transition hover:shadow-lg hover:bg-white/90 dark:hover:bg-gray-800/80">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-11 h-11 rounded-full bg-gradient-to-br from-brand to-purple-500 text-white flex items-center justify-center font-bold shadow-md text-lg">
                                        ${data.author.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 dark:text-white text-base">${data.author}</h3>
                                        <p class="text-xs text-gray-400">Student ‚Ä¢ Just now</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold border ${tagColor}">${data.tag}</span>
                                    ${data.author === localStorage.getItem("sx_user") ? `<button onclick="deletePost('${data.id}')" class="text-gray-400 hover:text-red-500 p-2 rounded-lg transition" title="Delete post"><i class="fas fa-trash-alt text-sm"></i></button>` : ''}
                                </div>
                            </div>
                            ${data.tag !== "Offering Skill" ? `<p class="text-gray-700 dark:text-gray-200 mb-5 text-sm leading-relaxed whitespace-pre-wrap pl-1">${data.title}</p>` : ''}
                            ${skillsHtml}
                            <div class="flex space-x-4 text-sm text-gray-500 dark:text-gray-400 border-t border-gray-100 dark:border-gray-700/50 pt-4 mt-4">
                                <button onclick="openDM('${data.author}')" class="flex items-center space-x-2 text-gray-500 hover:text-brand font-medium transition px-3 py-1.5 rounded-lg hover:bg-brandLight/50 dark:hover:bg-gray-700">
                                    <i class="far fa-comment-alt"></i> <span>Message</span>
                                </button>
                                <button onclick="initiateBond('${data.id}', '${data.author}')" class="flex items-center space-x-2 text-brand hover:text-brandDark font-medium transition px-3 py-1.5 rounded-lg hover:bg-brandLight/50 dark:hover:bg-gray-700" title="Create skill exchange bond">
                                    <i class="fas fa-handshake"></i> <span>Connect</span>
                                </button>
                                <button onclick="toggleLike('${data.id}')"
                                        class="flex items-center space-x-2 px-3 py-1.5 rounded-lg transition hover:bg-red-50 dark:hover:bg-red-900/10 ${hasLiked ? 'text-red-500' : 'hover:text-red-500'}">
                                  ${heartIcon}
                                  <span>${data.likes || 0}</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
            };

            window.handleSearch = function() {
                const query = document.getElementById('search-input').value.toLowerCase();
                const filteredPosts = allPosts.filter(post => 
                    post.title.toLowerCase().includes(query) || 
                    post.author.toLowerCase().includes(query)
                );
                renderFeed(filteredPosts);
            };

            window.filterPostsByTag = function(tag) {
                // Update active button styling
                document.querySelectorAll('.sort-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.closest('.sort-filter-btn').classList.add('active');

                // Filter and render posts
                let filteredPosts;
                if(tag === 'all') {
                    filteredPosts = allPosts;
                } else {
                    filteredPosts = allPosts.filter(post => post.tag === tag);
                }
                renderFeed(filteredPosts);
            };
            
            loadChatMessages();
        } else {
            alert("Please paste your Firebase API Key in the code!");
        }

        function loadProjects() {
          const container = document.getElementById("projects-container");
          if (!container) return;

          db.collection("projects").orderBy("timestamp", "desc").onSnapshot(snapshot => {
              container.innerHTML = "";
              if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-400 col-span-full text-center">No projects posted yet.</p>`;
                return;
              }
              snapshot.forEach(doc => {
                const p = doc.data();
                container.innerHTML += `
                  <div class="glass-card rounded-2xl overflow-hidden group">
                    <div class="h-36 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 group-hover:scale-105 transition-transform duration-500"></div>
                    <div class="p-6 relative">
                       <div class="absolute -top-6 right-6 w-12 h-12 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex items-center justify-center text-xl font-bold text-gray-800 dark:text-white border border-gray-100 dark:border-gray-700">
                          ${p.author.charAt(0)}
                       </div>
                      <h3 onclick="window.location.href='project.html?id=${p.id}'" class="font-bold text-xl mb-2 text-gray-900 dark:text-white cursor-pointer hover:text-brand transition">${p.title}</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-2">${p.description}</p>
                      <p class="text-xs text-gray-400 mb-5 font-mono bg-gray-50 dark:bg-gray-700/50 inline-block px-2 py-1 rounded">Tech: ${p.techStack || p.tech || "Not specified"}</p>
                      <div class="flex items-center justify-between border-t border-gray-100 dark:border-gray-700/50 pt-4">
                        <span class="text-xs font-semibold text-gray-500 dark:text-gray-400">By ${p.author}</span>
                        <div class="flex gap-2">
                          <button onclick="window.location.href='project.html?id=${doc.id}'" class="text-xs px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition">View</button>
                          <button onclick="messageProjectAuthor('${p.author}')" class="text-xs px-3 py-2 rounded-lg bg-brandLight dark:bg-gray-700/50 text-brand font-bold hover:bg-brand hover:text-white transition">Message</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
            });
        }
function loadHackRooms() {
  const container = document.getElementById("hackrooms-container");
  if (!container) return;

  db.collection("hackrooms").orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      container.innerHTML = "";

      if (snapshot.empty) {
        container.innerHTML =
          `<p class="text-gray-400 col-span-full text-center">
            No HackRooms yet.
          </p>`;
        return;
      }

      snapshot.forEach(doc => {
        const h = doc.data();
        container.innerHTML += `
          <div class="glass-card rounded-2xl p-6">
            <h3 class="font-bold text-xl text-gray-900 dark:text-white mb-1">
              ${h.hackathon}
            </h3>

            <p class="text-xs text-gray-400 mb-3">
              üìç ${h.location || "Not specified"}
            </p>

            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
              ${h.idea}
            </p>

            <p class="text-xs text-gray-400 mb-4">
              Looking for: <span class="font-semibold">${h.roles || "Any"}</span>
            </p>

            <div class="flex justify-between items-center border-t border-gray-100 dark:border-gray-700/50 pt-4">
              <span class="text-xs text-gray-500">
                By ${h.author}
              </span>
              <button onclick="openDM('${h.author}')"
                class="text-xs px-3 py-2 rounded-lg bg-brandLight text-brand font-bold hover:bg-brand hover:text-white transition">
                Message
              </button>
            </div>
          </div>
        `;
      });
    });
}
        
        function openMyProjects(btn) {
          const user = localStorage.getItem("sx_user");
          if (!user || user === "Guest") {
            alert("Please log in to view your projects.");
            return;
          }
          switchPage("my-projects", btn);
          loadMyProjects();
        }
        function loadMyProjects() {
          const container = document.getElementById("my-projects-container");
          const user = localStorage.getItem("sx_user");
          if (!container || !user) return;
          container.innerHTML = "";
          db.collection("projects").where("author", "==", user).get().then(snapshot => {
              if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-400 col-span-full text-center">You haven‚Äôt published any projects yet.</p>`;
                return;
              }
              snapshot.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                container.innerHTML += `
                  <div class="glass-card rounded-2xl overflow-hidden">
                    <div class="h-32 bg-gradient-to-r from-blue-500 to-cyan-500"></div>
                    <div class="p-6">
                      <h3 onclick="window.location.href='project.html?id=${p.id}'" class="font-bold text-lg mb-2 text-gray-900 dark:text-white cursor-pointer hover:text-brand transition">${p.title}</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${p.description}</p>
                      <p class="text-xs text-gray-400 mb-4">Tech: ${p.techStack || p.tech || "Not specified"}</p>
                      <div class="flex gap-3">
                        <button onclick="editProject('${p.id}', '${p.title}', '${p.description}', '${p.techStack || p.tech || ""}')" class="flex-1 text-xs px-3 py-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 font-bold hover:bg-blue-100 transition border border-blue-200 dark:border-blue-800">Edit</button>
                        <button onclick="deleteProject('${p.id}')" class="flex-1 text-xs px-3 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 font-bold hover:bg-red-100 transition border border-red-200 dark:border-red-800">Delete</button>
                      </div>
                    </div>
                  </div>
                `;
              });
            });
        }
        function deleteProject(projectId) {
          const confirmDelete = confirm("Are you sure you want to delete this project?");
          if (!confirmDelete) return;
          db.collection("projects").doc(projectId).delete().then(() => {
              loadMyProjects();
            }).catch(err => {
              alert("Failed to delete project");
              console.error(err);
            });
        }
        let editingProjectId = null;
        function editProject(id, title, desc, tech) {
          editingProjectId = id;
          document.getElementById("proj-title").value = title;
          document.getElementById("proj-desc").value = desc;
          document.getElementById("proj-tags").value = tech;
          toggleModal("project-modal");
        }
        function messageProjectAuthor(author) {
          const currentUser = localStorage.getItem("sx_user");
          if (!currentUser || currentUser === "Guest") {
            alert("Please log in to message users.");
            return;
          }
          if (author === currentUser) {
            alert("You cannot message yourself.");
            return;
          }
          openDM(author);
        }
        function openMyPosts(btn) {
          const user = localStorage.getItem("sx_user");
          if (!user || user === "Guest") {
            alert("Please log in to view your posts.");
            return;
          }
          switchPage("my-posts", btn || null);
          loadMyPosts();
        }
        function loadMyPosts() {
          const container = document.getElementById("my-posts-container");
          const user = localStorage.getItem("sx_user");
          if (!container) return;
          container.innerHTML = "";
          db.collection("questions").where("author", "==", user).get().then(snapshot => {
              if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-400 text-center">You haven‚Äôt posted anything yet.</p>`;
                return;
              }
              snapshot.forEach(doc => {
                const post = doc.data();
                container.innerHTML += `
                  <div class="glass-card p-6 rounded-2xl">
                    <p class="text-gray-800 dark:text-gray-200 mb-4 font-medium">${post.title}</p>
                    <div class="flex justify-between items-center text-sm border-t border-gray-100 dark:border-gray-700/50 pt-3">
                      <span class="text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs">${post.tag}</span>
                      <div class="flex gap-4">
                        <button onclick="editPost('${doc.id}', '${post.title}', '${post.tag}')" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">Edit</button>
                        <button onclick="deletePost('${doc.id}')" class="text-red-500 hover:underline font-semibold">Delete</button>
                      </div>
                    </div>
                  </div>
                `;
              });
            });
        }
        function deletePost(postId) {
          if (!confirm("Delete this post?")) return;
          db.collection("questions").doc(postId).delete().then(() => loadMyPosts());
        }
        let editingPostId = null;
        function editPost(id, title, tag) {
          editingPostId = id;
          document.getElementById("qa-title").value = title;
          document.getElementById("qa-tag").value = tag;
          toggleModal("qa-modal");
        }
        function toggleProfileMenu(event) {
          event.stopPropagation();
          const menu = document.getElementById("profile-menu");
          if (!menu) return;
          menu.classList.toggle("hidden");
        }
        function loadSavedDMs() {
            const user = localStorage.getItem("sx_user");
            if (!user || user === "Guest") return;
            const dmList = document.getElementById('dm-list');
            db.collection("chat_rooms").where("participants", "array-contains", user).onSnapshot(snapshot => {
                dmList.innerHTML = ''; 
                if (snapshot.empty) {
                    dmList.innerHTML = '<p class="text-xs text-gray-400 px-4 italic" id="no-dms-msg">No recent messages</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const roomId = doc.id;
                    const otherUser = data.participants.find(p => p !== user) || "Unknown";
                    dmList.innerHTML += `
                      <div id="room-${roomId}" class="chat-room-item flex items-center justify-between px-4 py-3 text-sm text-gray-600 dark:text-gray-300">
                        <div onclick="switchRoom('${roomId}', '${otherUser}')" class="flex items-center gap-3 cursor-pointer w-full">
                          <div class="w-2.5 h-2.5 rounded-full bg-green-500 shrink-0 shadow-[0_0_5px_rgba(34,197,94,0.5)]"></div>
                          <span class="truncate font-medium">${otherUser}</span>
                        </div>
                        <div class="relative shrink-0">
                          <button type="button" onclick="event.stopPropagation(); toggleDMMenu('${roomId}')" class="px-2 text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition">‚ãÆ</button>
                          <div id="menu-${roomId}" class="hidden absolute right-0 mt-1 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-xl z-50 w-28 overflow-hidden">
                            <button onclick="deletePersonalChat('${roomId}')" class="block w-full px-4 py-2 text-left text-sm text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 font-medium">Delete</button>
                          </div>
                        </div>
                      </div>
                    `;
                });
                if(currentRoomId && document.getElementById(`room-${currentRoomId}`)) {
                    document.getElementById(`room-${currentRoomId}`).classList.add('active');
                }
            });
        }
        function viewProjectDetails(projectId) {
          const modal = document.getElementById("project-details-modal");
          const titleEl = document.getElementById("detail-title");
          const descEl = document.getElementById("detail-desc");
          const authorEl = document.getElementById("detail-author");
          const techEl = document.getElementById("detail-tech");
          const dateEl = document.getElementById("detail-date");
          const msgBtn = document.getElementById("detail-message-btn");
          toggleModal("project-details-modal");
          db.collection("projects").doc(projectId).get().then(doc => {
            if (!doc.exists) {
              titleEl.innerText = "Project not found";
              return;
            }
            const data = doc.data();
            titleEl.innerText = data.title;
            descEl.innerText = data.description;
            authorEl.innerText = data.author;
            dateEl.innerText = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : "Recently";
            const techStack = (data.techStack || "").split(",");
            techEl.innerHTML = techStack.map(t =>
              `<span class="px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 text-xs rounded-full border border-indigo-100 dark:border-indigo-800 font-medium">${t.trim()}</span>`
            ).join("");
            msgBtn.onclick = () => {
              toggleModal("project-details-modal");
              messageProjectAuthor(data.author);
            };
          });
        }

        function switchPage(pageId, btnElement) {
  document.querySelectorAll('.page-section')
    .forEach(el => el.classList.remove('active-page'));

  document.getElementById(pageId).classList.add('active-page');

  document.querySelectorAll('.sidebar-link')
    .forEach(el => el.classList.remove('active'));

  if (btnElement) btnElement.classList.add('active');

  if (pageId === "seniors") loadSeniorProfiles();
  if (pageId === "hackrooms") loadHackRooms();
  if (pageId === "skill-matches") loadSkillMatches();
  if (pageId === "bond-requests") loadBondRequests();
  if (pageId === "bond-history") loadBondHistory();

  const titles = {
    explore: 'Explore Feed',
    projects: 'Projects',
    'my-projects': 'My Projects',
    'my-posts': 'My Posts',
    seniors: 'Community',
    hackrooms: 'HackRooms',
    'skill-matches': 'Skill Matches',
    'bond-requests': 'Bond Requests',
    'bond-history': 'Bond History',
    chat: 'Messages'
  };

  document.getElementById('header-title').innerText = titles[pageId] || '';
}


        function updateUserUI(name) {
          const initial = name.charAt(0).toUpperCase();
          document.getElementById("user-name-display").innerText = name;
          document.getElementById("user-avatar").innerText = initial;
          const cardName = document.getElementById("card-user-name");
          const cardAvatar = document.getElementById("card-user-avatar");
          if (cardName) cardName.innerText = name;
          if (cardAvatar) cardAvatar.innerText = initial;
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.classList.toggle('hidden'); m.classList.toggle('flex');
        }

        function switchRoom(roomId, roomName) {
            currentRoomId = roomId;
            currentRoomName = roomName;
            document.querySelectorAll('.chat-room-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`room-${roomId}`);
            if(activeEl) activeEl.classList.add('active');
            document.getElementById('chat-header-name').innerText = roomName;
            document.getElementById('chat-header-icon').className = roomId.startsWith('dm_') ? 'fas fa-user' : 'fas fa-hashtag';
            
            // Show delete button only for DMs (direct messages)
            const deleteBtn = document.getElementById('delete-chat-btn');
            if (deleteBtn) {
              if (roomId.startsWith('dm_')) {
                deleteBtn.classList.remove('hidden');
              } else {
                deleteBtn.classList.add('hidden');
              }
            }
            
            loadChatMessages();
        }

        function openDM(targetUser) {
            const currentUser = localStorage.getItem('sx_user');
            if(!currentUser || currentUser === "Guest") {
                alert("Please log in to chat.");
                return;
            }
            if(targetUser === currentUser) {
                alert("You cannot message yourself.");
                return;
            }
            const users = [currentUser, targetUser].sort();
            const roomId = `dm_${users[0]}_${users[1]}`;
            db.collection("chat_rooms").doc(roomId).set({
                roomId: roomId,
                participants: [currentUser, targetUser],
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                switchPage('chat', document.querySelector("div[onclick=\"switchPage('chat', this)\"]"));
                switchRoom(roomId, targetUser);
            }).catch(err => console.error("Error creating chat room:", err));
        }
        function toggleDMMenu(roomId) {
          const menu = document.getElementById(`menu-${roomId}`);
          if (!menu) return;
          document.querySelectorAll('[id^="menu-dm_"]').forEach(m => {
            if (m !== menu) m.classList.add("hidden");
          });
          menu.classList.toggle("hidden");
        }
        function deletePersonalChat(roomId) {
          if (!confirm("Delete this chat permanently?")) return;
          if (unsubscribeChat) {
            unsubscribeChat();
            unsubscribeChat = null;
          }
          db.collection("messages").where("roomId", "==", roomId).get().then(snapshot => {
              if (snapshot.empty) return;
              const batch = db.batch();
              snapshot.forEach(doc => {
                batch.delete(doc.ref);
              });
              return batch.commit();
            }).then(() => {
              return db.collection("chat_rooms").doc(roomId).delete();
            }).then(() => {
              const dmEl = document.getElementById(`room-${roomId}`);
              if (dmEl) dmEl.remove();
              document.getElementById("chat-messages").innerHTML = "";
              currentRoomId = "general";
              alert("Chat deleted successfully");
            }).catch(err => {
              console.error("Delete failed:", err);
              alert("Failed to delete chat. Check console.");
            });
        }

        // Delete current chat from header button (for direct messages only)
        function deleteCurrentChat() {
          if (currentRoomId === "general" || currentRoomId === "projects") {
            alert("You cannot delete group chats.");
            return;
          }
          
          // Authorization check - verify user is a participant
          db.collection("chat_rooms").doc(currentRoomId).get().then(doc => {
            if (!doc.exists) {
              alert("Chat room not found.");
              return;
            }

            const currentUser = localStorage.getItem("sx_user");
            const participants = doc.data().participants || [];

            if (!participants.includes(currentUser)) {
              alert("You don't have permission to delete this chat.");
              return;
            }

            if (confirm("Delete this conversation permanently? This action cannot be undone.")) {
              deletePersonalChat(currentRoomId);
            }
          }).catch(err => {
            console.error("Error checking chat permissions:", err);
            alert("Error deleting chat");
          });
        }


        function loadChatMessages() {
          const box = document.getElementById("chat-messages");
          if (!box) return;
          
          // Unsubscribe from previous listener
          if (unsubscribeChat) unsubscribeChat();
          
          box.innerHTML = "";
          
          // Set up real-time listener for messages - simple version that works
          unsubscribeChat = db.collection("messages")
            .where("roomId", "==", currentRoomId)
            .onSnapshot(snapshot => {
              // Clear only on first load
              if (box.children.length === 0) {
                box.innerHTML = "";
              }
              
              snapshot.forEach(doc => {
                const data = doc.data();
                const messageId = doc.id;
                const currentUser = localStorage.getItem("sx_user");
                const isMe = data.user === currentUser;
                
                // Skip if message already exists in DOM
                if (document.getElementById(`msg-${messageId}`)) return;
                
                const msgWrapper = document.createElement("div");
                msgWrapper.id = `msg-${messageId}`;
                msgWrapper.className = `flex flex-col ${isMe ? "items-end" : "items-start"} mb-4 animate-fadeIn group`;
                msgWrapper.innerHTML = `
                  <span class="text-[10px] text-gray-400 mb-1 ${isMe ? "mr-2" : "ml-2"} font-medium uppercase tracking-wide">${isMe ? "You" : data.user}</span>
                  <div class="relative">
                    <div class="message-bubble max-w-xs md:max-w-md px-5 py-3 rounded-2xl text-sm shadow-sm cursor-default select-none ${isMe ? "bg-brand text-white rounded-br-none" : "bg-white dark:bg-gray-700 dark:text-white rounded-bl-none"}"
                         onmousedown="startLongPress(event, '${messageId}', '${data.user}', '${currentUser}')"
                         ontouchstart="startLongPress(event, '${messageId}', '${data.user}', '${currentUser}')">
                      ${data.text}
                    </div>
                    ${isMe ? `<div class="absolute -right-12 top-0 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button onclick="showMessageMenu(event, '${messageId}', '${data.user}')" class="text-gray-400 hover:text-red-500 p-1 text-xs">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                    </div>` : ''}
                  </div>
                `;
                box.appendChild(msgWrapper);
              });
              
              box.scrollTop = box.scrollHeight;
            }, error => {
              console.error("Error loading messages:", error);
            });
        }

        // Long press tracking
        let longPressTimer = null;
        let longPressStartX = 0;
        let longPressStartY = 0;

        function startLongPress(event, messageId, messageAuthor, currentUser) {
          // Only allow long press on own messages
          if (messageAuthor !== currentUser) return;

          longPressStartX = event.clientX || event.touches?.[0]?.clientX || 0;
          longPressStartY = event.clientY || event.touches?.[0]?.clientY || 0;

          longPressTimer = setTimeout(() => {
            showMessageMenu(event, messageId, messageAuthor);
          }, 500); // 500ms long press

          // Cancel long press if user moves
          const handleMove = (moveEvent) => {
            const newX = moveEvent.clientX || moveEvent.touches?.[0]?.clientX || 0;
            const newY = moveEvent.clientY || moveEvent.touches?.[0]?.clientY || 0;
            const distance = Math.sqrt(
              Math.pow(newX - longPressStartX, 2) + Math.pow(newY - longPressStartY, 2)
            );

            if (distance > 10) {
              clearTimeout(longPressTimer);
              document.removeEventListener('mousemove', handleMove);
              document.removeEventListener('touchmove', handleMove);
            }
          };

          document.addEventListener('mousemove', handleMove, { once: false });
          document.addEventListener('touchmove', handleMove, { once: false });

          // Clean up on release
          const handleRelease = () => {
            clearTimeout(longPressTimer);
            document.removeEventListener('mousemove', handleMove);
            document.removeEventListener('touchmove', handleMove);
            document.removeEventListener('mouseup', handleRelease);
            document.removeEventListener('touchend', handleRelease);
          };

          document.addEventListener('mouseup', handleRelease, { once: true });
          document.addEventListener('touchend', handleRelease, { once: true });
        }

        // Show message action menu
        function showMessageMenu(event, messageId, messageAuthor) {
          event.preventDefault();
          event.stopPropagation();
          clearTimeout(longPressTimer);

          const currentUser = localStorage.getItem("sx_user");
          
          // Security check - only message author can delete
          if (messageAuthor !== currentUser) {
            return;
          }

          // Close any existing menus
          document.querySelectorAll('.message-action-menu').forEach(menu => menu.remove());

          // Create action menu
          const menu = document.createElement('div');
          menu.className = 'message-action-menu fixed bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 z-50 overflow-hidden';
          menu.innerHTML = `
            <button onclick="deleteMessage('${messageId}')" class="w-full px-4 py-2 text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium flex items-center gap-2 transition">
              <i class="fas fa-trash-alt text-sm"></i> Delete Message
            </button>
          `;

          // Position menu near the click
          const msgElement = document.getElementById(`msg-${messageId}`);
          if (msgElement) {
            const rect = msgElement.getBoundingClientRect();
            menu.style.top = (rect.top + window.scrollY) + 'px';
            menu.style.left = (rect.right - 180) + 'px';
          } else {
            menu.style.top = (event.clientY) + 'px';
            menu.style.left = (event.clientX - 180) + 'px';
          }

          document.body.appendChild(menu);

          // Close menu when clicking outside
          setTimeout(() => {
            const closeMenu = (e) => {
              if (!menu.contains(e.target) && e.target !== document.getElementById(`msg-${messageId}`)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
              }
            };
            document.addEventListener('click', closeMenu);
          }, 0);
        }

        // Delete individual message
        function deleteMessage(messageId) {
          const currentUser = localStorage.getItem("sx_user");

          // Get message data for authorization
          db.collection("messages").doc(messageId).get().then(doc => {
            if (!doc.exists) {
              alert("Message not found.");
              return;
            }

            const messageData = doc.data();

            // Authorization check - only message author can delete
            if (messageData.user !== currentUser) {
              alert("You can only delete your own messages.");
              return;
            }

            // Show confirmation dialog
            if (confirm("Delete this message? This action cannot be undone.")) {
              // Delete from database
              db.collection("messages").doc(messageId).delete()
                .then(() => {
                  console.log(`Message ${messageId} deleted successfully`);
                  // UI update happens automatically via the onSnapshot listener
                })
                .catch(error => {
                  console.error("Error deleting message:", error);
                  alert("Failed to delete message. Please try again.");
                });
            }

            // Close the action menu
            document.querySelectorAll('.message-action-menu').forEach(menu => menu.remove());
          }).catch(error => {
            console.error("Error fetching message:", error);
            alert("Error deleting message. Please try again.");
          });
        }

        function sendChat() {
            const input = document.getElementById("chat-input");
            if(input.value.trim()) {
                db.collection("messages").add({
                    text: input.value.trim(), user: localStorage.getItem('sx_user'), roomId: currentRoomId, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = "";
            }
        }

        function postQuestion() {
          const tag = document.getElementById('qa-tag').value;
          const author = localStorage.getItem("sx_user");
          
          if (!author || author === "Guest") {
            alert("Please log in to post.");
            return;
          }

          let postData = {
            tag,
            author,
            likes: 0,
            likedBy: {},
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          if(tag === "Offering Skill") {
            const skillsOffer = window.skillsOfferArray || [];
            const skillsLearn = window.skillsLearnArray || [];
            const description = document.getElementById('course-description').value.trim();

            if(skillsOffer.length === 0) {
              alert("Please add at least one skill to offer.");
              return;
            }

            postData.title = `Teaching: ${skillsOffer.join(", ")}`;
            postData.skillsToOffer = skillsOffer;
            postData.skillsToLearn = skillsLearn;
            if(description) {
              postData.courseDescription = description;
            }
          } else {
            const title = document.getElementById('qa-title').value;
            if (!title || title.trim() === "") {
              alert("Please enter content for your post.");
              return;
            }
            postData.title = title;
          }

          if (editingPostId) {
            db.collection("questions").doc(editingPostId).update(postData).then(() => {
              editingPostId = null;
              toggleModal('qa-modal');
              loadMyPosts();
              resetModalForm();
            });
            return;
          }

          db.collection("questions").add(postData);
          toggleModal('qa-modal');
          resetModalForm();
        }

        function resetModalForm() {
          document.getElementById('qa-title').value = "";
          document.getElementById('qa-tag').value = "General";
          document.getElementById('course-description').value = "";
          document.getElementById('skills-offer-tags').innerHTML = "";
          document.getElementById('skills-learn-tags').innerHTML = "";
          document.getElementById('skills-offer-input').value = "";
          document.getElementById('skills-learn-input').value = "";
          window.skillsOfferArray = [];
          window.skillsLearnArray = [];
          updateFormFields();
        }

        function updateFormFields() {
          const tag = document.getElementById('qa-tag').value;
          const defaultFields = document.getElementById('default-fields');
          const offeringFields = document.getElementById('offering-fields');

          if(tag === "Offering Skill") {
            defaultFields.classList.add('hidden');
            offeringFields.classList.remove('hidden');
          } else {
            defaultFields.classList.remove('hidden');
            offeringFields.classList.add('hidden');
          }
        }

        function handleSkillInput(event, type) {
          if(event.key === 'Enter') {
            event.preventDefault();
            const input = type === 'offer' ? 
              document.getElementById('skills-offer-input') : 
              document.getElementById('skills-learn-input');
            
            const skill = input.value.trim();
            if(skill === "") return;

            const array = type === 'offer' ? window.skillsOfferArray : window.skillsLearnArray;
            if(array.includes(skill)) {
              alert("This skill is already added.");
              return;
            }

            array.push(skill);
            input.value = "";
            renderSkillTags(type);
          }
        }

        function removeSkill(skill, type) {
          const array = type === 'offer' ? window.skillsOfferArray : window.skillsLearnArray;
          array.splice(array.indexOf(skill), 1);
          renderSkillTags(type);
        }

        function renderSkillTags(type) {
          const array = type === 'offer' ? window.skillsOfferArray : window.skillsLearnArray;
          const container = type === 'offer' ? 
            document.getElementById('skills-offer-tags') : 
            document.getElementById('skills-learn-tags');

          container.innerHTML = array.map(skill => `
            <div class="skill-tag">
              ${skill}
              <button onclick="removeSkill('${skill}', '${type}')" title="Remove"><i class="fas fa-times"></i></button>
            </div>
          `).join('');
        }

        // Initialize skill arrays
        window.skillsOfferArray = [];
        window.skillsLearnArray = [];

        /* ============ SKILL MATCHING SYSTEM ============ */

        // Normalize skill for case-insensitive comparison
        function normalizeSkill(skill) {
          return skill.toLowerCase().trim();
        }

        // Check if two skills match (case-insensitive, partial match support)
        function skillsMatch(skill1, skill2) {
          const norm1 = normalizeSkill(skill1);
          const norm2 = normalizeSkill(skill2);
          
          // Exact match
          if (norm1 === norm2) return true;
          
          // Partial match (either contains the other)
          if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
          
          return false;
        }

        // Find matching skills between two arrays
        function findMatchingSkills(userOffering, otherUserWants) {
          const matches = [];
          userOffering.forEach(offer => {
            otherUserWants.forEach(want => {
              if (skillsMatch(offer, want)) {
                matches.push({
                  offered: offer,
                  wanted: want
                });
              }
            });
          });
          return matches;
        }

        // Calculate match score between two users
        function calculateMatchScore(userOffer, userLearn, otherUserOffer, otherUserLearn) {
          let score = 0;
          let matchDetails = {};

          // Check if current user's offers match other user's wants
          const userOffersToOther = findMatchingSkills(userOffer, otherUserLearn);
          score += userOffersToOther.length * 2;
          if (userOffersToOther.length > 0) {
            matchDetails.userCanTeach = userOffersToOther;
          }

          // Check if current user wants what other user offers
          const userWantsFromOther = findMatchingSkills(otherUserOffer, userLearn);
          score += userWantsFromOther.length * 2;
          if (userWantsFromOther.length > 0) {
            matchDetails.userCanLearnFrom = userWantsFromOther;
          }

          return { score, details: matchDetails };
        }

        // Load and display skill matches
        function loadSkillMatches() {
          const container = document.getElementById('skill-matches-container');
          if (!container) return;

          const currentUser = localStorage.getItem('sx_user');
          if (!currentUser || currentUser === 'Guest') {
            container.innerHTML = '<p class="text-center text-gray-400 py-10">Please log in to view skill matches.</p>';
            return;
          }

          container.innerHTML = '<p class="text-center text-gray-400 py-10 animate-pulse">Loading skill matches...</p>';

          // Get current user's offering posts
          db.collection('questions')
            .where('author', '==', currentUser)
            .where('tag', '==', 'Offering Skill')
            .get()
            .then(snapshot => {
              let currentUserSkills = { offer: [], learn: [] };
              
              if (!snapshot.empty) {
                snapshot.forEach(doc => {
                  const data = doc.data();
                  currentUserSkills.offer.push(...(data.skillsToOffer || []));
                  currentUserSkills.learn.push(...(data.skillsToLearn || []));
                });
              }

              if (currentUserSkills.offer.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-10">Create an "Offering Skill" post to find matches.</p>';
                return;
              }

              // Get all offering posts from other users
              db.collection('questions')
                .where('tag', '==', 'Offering Skill')
                .get()
                .then(allSnapshot => {
                  const matches = [];

                  allSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.author === currentUser) return; // Skip own posts

                    const matchResult = calculateMatchScore(
                      currentUserSkills.offer,
                      currentUserSkills.learn,
                      data.skillsToOffer || [],
                      data.skillsToLearn || []
                    );

                    if (matchResult.score > 0) {
                      matches.push({
                        id: doc.id,
                        ...data,
                        matchScore: matchResult.score,
                        matchDetails: matchResult.details
                      });
                    }
                  });

                  // Sort by match score
                  matches.sort((a, b) => b.matchScore - a.matchScore);

                  // Store for filtering
                  window.allSkillMatches = matches;
                  renderSkillMatches(matches);
                });
            });
        }

        // Render skill matches
        function renderSkillMatches(matches) {
          const container = document.getElementById('skill-matches-container');
          if (matches.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-10">No skill matches found. Try expanding your skills!</p>';
            return;
          }

          container.innerHTML = matches.map(match => {
            const canTeach = match.matchDetails.userCanTeach || [];
            const canLearn = match.matchDetails.userCanLearnFrom || [];

            let matchContent = '';
            if (canTeach.length > 0) {
              const skills = canTeach.map(m => `<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-xs font-medium">${m.offered}</span>`).join('');
              matchContent += `<div><p class="text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mb-2">You can teach ${match.author}:</p><div class="flex flex-wrap gap-2">${skills}</div></div>`;
            }

            if (canLearn.length > 0) {
              const skills = canLearn.map(m => `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-xs font-medium">${m.offered}</span>`).join('');
              matchContent += `<div class="mt-3"><p class="text-xs font-bold text-gray-600 dark:text-gray-400 uppercase mb-2">You can learn from ${match.author}:</p><div class="flex flex-wrap gap-2">${skills}</div></div>`;
            }

            return `
              <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-brand to-purple-500 text-white flex items-center justify-center font-bold shadow-md text-lg">
                      ${match.author.charAt(0).toUpperCase()}
                    </div>
                    <div>
                      <h3 class="font-bold text-gray-800 dark:text-white">${match.author}</h3>
                      <p class="text-xs text-gray-400">Student</p>
                    </div>
                  </div>
                  <div class="bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full">
                    <p class="text-xs font-bold text-green-700 dark:text-green-300">‚≠ê ${match.matchScore} Points</p>
                  </div>
                </div>

                <div class="bg-gray-50/50 dark:bg-gray-700/30 rounded-xl p-4 mb-4 space-y-3 border border-gray-100 dark:border-gray-600/30">
                  ${matchContent}
                </div>

                <div class="flex gap-3">
                  <button onclick="openDM('${match.author}')" class="flex-1 bg-brand text-white px-4 py-2 rounded-lg font-semibold hover:bg-brandDark transition">
                    <i class="fas fa-message mr-2"></i>Message
                  </button>
                  <button onclick="openUserProfile('${match.author}')" class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                    View Profile
                  </button>
                </div>
              </div>
            `;
          }).join('');
        }

        // Filter matches based on search inputs
        function filterMatches() {
          const searchOffer = normalizeSkill(document.getElementById('match-search-offer').value);
          const searchLearn = normalizeSkill(document.getElementById('match-search-learn').value);

          if (!window.allSkillMatches) {
            loadSkillMatches();
            return;
          }

          let filtered = window.allSkillMatches;

          if (searchOffer) {
            filtered = filtered.filter(match => {
              return (match.matchDetails.userCanTeach || []).some(m => 
                normalizeSkill(m.offered).includes(searchOffer) || 
                normalizeSkill(m.wanted).includes(searchOffer)
              );
            });
          }

          if (searchLearn) {
            filtered = filtered.filter(match => {
              return (match.matchDetails.userCanLearnFrom || []).some(m => 
                normalizeSkill(m.offered).includes(searchLearn) || 
                normalizeSkill(m.wanted).includes(searchLearn)
              );
            });
          }

          renderSkillMatches(filtered);
        }

        // Load and display bond requests
        function loadBondRequests() {
          const currentUser = localStorage.getItem('sx_user');
          if (!currentUser || currentUser === 'Guest') {
            document.getElementById('incoming-requests').innerHTML = '<p class="text-center text-gray-400 py-10">Please log in to view bond requests.</p>';
            document.getElementById('outgoing-requests').innerHTML = '<p class="text-center text-gray-400 py-10">Please log in to view bond requests.</p>';
            return;
          }

          // Load incoming requests (requests sent to current user)
          const incomingContainer = document.getElementById('incoming-requests');
          incomingContainer.innerHTML = '<p class="text-center text-gray-400 py-10 animate-pulse">Loading incoming requests...</p>';

          db.collection('bond_requests')
            .where('tutorId', '==', currentUser)
            .where('status', '==', 'pending')
            .orderBy('sentAt', 'desc')
            .onSnapshot(snapshot => {
              if (snapshot.empty) {
                incomingContainer.innerHTML = '<p class="text-center text-gray-400 py-10">No incoming bond requests.</p>';
              } else {
                incomingContainer.innerHTML = snapshot.docs.map(doc => {
                  const req = doc.data();
                  return `
                    <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl border-l-4 border-yellow-500">
                      <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 text-white flex items-center justify-center font-bold shadow-md text-lg">
                            ${req.learnerId.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <h3 class="font-bold text-gray-800 dark:text-white">${req.learnerId}</h3>
                            <p class="text-xs text-gray-400">Wants to learn from you</p>
                          </div>
                        </div>
                      </div>

                      <div class="bg-gray-50/50 dark:bg-gray-700/30 rounded-xl p-4 mb-4 space-y-2 border border-gray-100 dark:border-gray-600/30">
                        <div class="flex items-center gap-2">
                          <span class="text-sm font-bold text-gray-600 dark:text-gray-400">Can teach you:</span>
                          <span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-sm font-medium">${req.skillOffered}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-sm font-bold text-gray-600 dark:text-gray-400">Wants to learn:</span>
                          <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-sm font-medium">${req.skillLearned}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">${req.sentAt ? req.sentAt.toDate().toLocaleDateString() : 'Recently'}</p>
                      </div>

                      <div class="flex gap-3">
                        <button onclick="acceptBondRequest('${doc.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                          <i class="fas fa-check mr-2"></i>Accept
                        </button>
                        <button onclick="rejectBondRequest('${doc.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                          <i class="fas fa-times mr-2"></i>Reject
                        </button>
                      </div>
                    </div>
                  `;
                }).join('');
              }
            });

          // Load outgoing requests (requests sent by current user)
          const outgoingContainer = document.getElementById('outgoing-requests');
          outgoingContainer.innerHTML = '<p class="text-center text-gray-400 py-10 animate-pulse">Loading outgoing requests...</p>';

          db.collection('bond_requests')
            .where('learnerId', '==', currentUser)
            .where('status', '==', 'pending')
            .orderBy('sentAt', 'desc')
            .onSnapshot(snapshot => {
              if (snapshot.empty) {
                outgoingContainer.innerHTML = '<p class="text-center text-gray-400 py-10">No outgoing bond requests.</p>';
              } else {
                outgoingContainer.innerHTML = snapshot.docs.map(doc => {
                  const req = doc.data();
                  return `
                    <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl border-l-4 border-blue-500">
                      <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center font-bold shadow-md text-lg">
                            ${req.tutorId.charAt(0).toUpperCase()}
                          </div>
                          <div>
                            <h3 class="font-bold text-gray-800 dark:text-white">${req.tutorId}</h3>
                            <p class="text-xs text-gray-400">Request awaiting response</p>
                          </div>
                        </div>
                      </div>

                      <div class="bg-gray-50/50 dark:bg-gray-700/30 rounded-xl p-4 mb-4 space-y-2 border border-gray-100 dark:border-gray-600/30">
                        <div class="flex items-center gap-2">
                          <span class="text-sm font-bold text-gray-600 dark:text-gray-400">They can teach:</span>
                          <span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-sm font-medium">${req.skillOffered}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span class="text-sm font-bold text-gray-600 dark:text-gray-400">You want:</span>
                          <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-sm font-medium">${req.skillLearned}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">${req.sentAt ? req.sentAt.toDate().toLocaleDateString() : 'Recently'}</p>
                      </div>

                      <div class="flex gap-3">
                        <button onclick="cancelBondRequest('${doc.id}')" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                          <i class="fas fa-ban mr-2"></i>Cancel Request
                        </button>
                      </div>
                    </div>
                  `;
                }).join('');
              }
            });
        }

        // Cancel a bond request (by sender)
        async function cancelBondRequest(requestId) {
          const currentUser = localStorage.getItem('sx_user');
          
          try {
            const reqDoc = await db.collection('bond_requests').doc(requestId).get();
            if (!reqDoc.exists) {
              alert('Request not found');
              return;
            }

            const request = reqDoc.data();
            
            // Verify current user is the sender (learner)
            if (request.learnerId !== currentUser) {
              alert('You can only cancel requests you sent');
              return;
            }

            // Delete the request
            await db.collection('bond_requests').doc(requestId).delete();
            alert('Bond request cancelled.');
            loadBondRequests();

          } catch (error) {
            console.error('Error cancelling bond request:', error);
            alert('Failed to cancel request. Please try again.');
          }
        }

        // Load and display bond history (all active and completed bonds)
        function loadBondHistory() {
          const currentUser = localStorage.getItem('sx_user');
          if (!currentUser || currentUser === 'Guest') {
            document.getElementById('bond-history-container').innerHTML = '<p class="text-center text-gray-400 py-10">Please log in to view bond history.</p>';
            return;
          }

          const container = document.getElementById('bond-history-container');
          container.innerHTML = '<p class="text-center text-gray-400 py-10 animate-pulse">Loading bond history...</p>';

          // Get all bonds where user is tutor or learner
          db.collection('bonds')
            .where('tutorId', 'in', [currentUser])
            .orderBy('createdAt', 'desc')
            .onSnapshot(snapshot => {
              let bonds = [];
              snapshot.forEach(doc => {
                bonds.push({ id: doc.id, ...doc.data() });
              });

              // Also get bonds where user is learner
              db.collection('bonds')
                .where('learnerId', '==', currentUser)
                .orderBy('createdAt', 'desc')
                .get()
                .then(learnSnapshot => {
                  learnSnapshot.forEach(doc => {
                    const bond = { id: doc.id, ...doc.data() };
                    // Avoid duplicates
                    if (!bonds.find(b => b.id === bond.id)) {
                      bonds.push(bond);
                    }
                  });

                  // Sort by creation date
                  bonds.sort((a, b) => {
                    const aTime = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const bTime = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return bTime - aTime;
                  });

                  if (bonds.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-400 py-10">No bond history yet. Create a bond to get started!</p>';
                    return;
                  }

                  container.innerHTML = bonds.map(bond => {
                    const isUserTutor = bond.tutorId === currentUser;
                    const otherUser = isUserTutor ? bond.learnerId : bond.tutorId;
                    const userRole = isUserTutor ? 'Tutor' : 'Learner';
                    const statusColor = bond.status === 'active' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300';
                    const createdDate = bond.createdAt ? bond.createdAt.toDate().toLocaleDateString() : 'Recently';

                    return `
                      <div class="glass-card bg-white/60 dark:bg-gray-800/60 p-6 rounded-2xl border-l-4 border-purple-500">
                        <div class="flex items-start justify-between mb-4">
                          <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 text-white flex items-center justify-center font-bold shadow-md text-lg">
                              ${otherUser.charAt(0).toUpperCase()}
                            </div>
                            <div>
                              <h3 class="font-bold text-gray-800 dark:text-white">${otherUser}</h3>
                              <p class="text-xs text-gray-400">You are the ${userRole}</p>
                            </div>
                          </div>
                          <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
                            ${bond.status === 'active' ? 'üü¢ Active' : '‚úì Completed'}
                          </span>
                        </div>

                        <div class="bg-gray-50/50 dark:bg-gray-700/30 rounded-xl p-4 mb-4 space-y-2 border border-gray-100 dark:border-gray-600/30">
                          <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-400">Teaching:</span>
                            <span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded text-sm font-medium">${bond.skillOffered}</span>
                          </div>
                          <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-400">Learning:</span>
                            <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-sm font-medium">${bond.skillLearned}</span>
                          </div>
                          <p class="text-xs text-gray-400 mt-3">Started on ${createdDate}</p>
                        </div>

                        ${bond.assessmentScore ? `
                          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-3 mb-4 border border-blue-100 dark:border-blue-800">
                            <p class="text-xs font-bold text-blue-700 dark:text-blue-300 mb-1">Assessment Score: ${bond.assessmentScore}/100</p>
                            <p class="text-xs text-blue-600 dark:text-blue-400">Assessed by ${bond.assessmentSubmittedBy || 'Tutor'}</p>
                          </div>
                        ` : ''}

                        ${bond.feedback ? `
                          <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-3 mb-4 border border-purple-100 dark:border-purple-800">
                            <p class="text-xs font-bold text-purple-700 dark:text-purple-300 mb-2">Feedback:</p>
                            <p class="text-xs text-purple-600 dark:text-purple-400">${bond.feedback}</p>
                          </div>
                        ` : ''}

                        <div class="flex gap-3">
                          <button onclick="viewBondDetails('${bond.id}')" class="flex-1 bg-brand text-white px-4 py-2 rounded-lg font-semibold hover:bg-brandDark transition">
                            <i class="fas fa-eye mr-2"></i>View Details
                          </button>
                          ${bond.status === 'active' && isUserTutor ? `
                            <button onclick="createAssessment('${bond.id}')" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                              <i class="fas fa-clipboard-check mr-2"></i>Assess
                            </button>
                          ` : ''}
                          ${bond.status === 'active' ? `
                            <button onclick="breakBond('${bond.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition">
                              <i class="fas fa-link-slash mr-2"></i>End Bond
                            </button>
                          ` : ''}
                        </div>
                      </div>
                    `;
                  }).join('');
                });
            });
        }

        // Placeholder functions for bond actions
        function viewBondDetails(bondId) {
          alert('Bond details view coming soon for bond: ' + bondId);
        }

        function createAssessment(bondId) {
          alert('Assessment creation coming soon for bond: ' + bondId);
        }

        function breakBond(bondId) {
          const reason = prompt('Why are you ending this bond?');
          if (!reason) return;
          
          db.collection('bonds').doc(bondId).update({
            status: 'broken',
            bondBreakReason: reason,
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            alert('Bond ended successfully.');
            loadBondHistory();
          }).catch(err => {
            console.error('Error breaking bond:', err);
            alert('Failed to end bond. Please try again.');
          });
        }

        // Update notification badge with pending request count
        function updateBondRequestBadge() {
          const currentUser = localStorage.getItem('sx_user');
          const badge = document.getElementById('bond-req-badge');
          
          if (!currentUser || currentUser === 'Guest' || !badge) {
            if (badge) badge.classList.add('hidden');
            return;
          }

          db.collection('bond_requests')
            .where('tutorId', '==', currentUser)
            .where('status', '==', 'pending')
            .onSnapshot(snapshot => {
              const count = snapshot.size;
              
              if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
              } else {
                badge.classList.add('hidden');
              }
            });
        }

        // Call badge update on auth state change
        auth.onAuthStateChanged(() => {
          setTimeout(() => updateBondRequestBadge(), 1000);
        });

        // Shared Bond Interface Functions
        let currentBondId = null;
        let currentBondData = null;

        function viewBondDetails(bondId) {
          const currentUser = localStorage.getItem('sx_user');
          
          db.collection('bonds').doc(bondId).get().then(doc => {
            if (!doc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = { id: doc.id, ...doc.data() };
            currentBondId = bondId;
            currentBondData = bond;

            const isUserTutor = bond.tutorId === currentUser;
            const partnerName = isUserTutor ? bond.learnerId : bond.tutorId;
            const partnerRole = isUserTutor ? 'Learner' : 'Tutor';

            // Update UI elements
            document.getElementById('bond-title').textContent = `${bond.skillOffered} ‚Üî ${bond.skillLearned}`;
            document.getElementById('bond-subtitle').textContent = `Skill exchange with ${partnerName}`;
            document.getElementById('bond-partner-name').textContent = partnerName;
            document.getElementById('bond-partner-role').textContent = partnerRole;
            document.getElementById('bond-partner-avatar').textContent = partnerName.charAt(0).toUpperCase();
            document.getElementById('bond-skill-offered').textContent = bond.skillOffered;
            document.getElementById('bond-skill-learned').textContent = bond.skillLearned;
            document.getElementById('bond-id').textContent = bondId;
            document.getElementById('bond-created-date').textContent = `Created on ${bond.createdAt ? bond.createdAt.toDate().toLocaleDateString() : 'Recently'}`;

            // Calculate duration
            const now = new Date();
            const created = bond.createdAt ? bond.createdAt.toDate() : new Date();
            const daysActive = Math.floor((now - created) / (1000 * 60 * 60 * 24));
            document.getElementById('bond-duration').textContent = `${daysActive} days active`;

            // Show assessment section only if tutor
            const assessmentSection = document.getElementById('assessment-section');
            const submitAssessmentBtn = document.getElementById('submit-assessment-btn');
            if (isUserTutor && bond.status === 'active') {
              assessmentSection.classList.remove('hidden');
              if (bond.assessmentScore) {
                submitAssessmentBtn.innerHTML = `<i class="fas fa-pencil mr-2"></i>Update Assessment`;
              } else {
                submitAssessmentBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Add Assessment`;
              }
            } else {
              assessmentSection.classList.add('hidden');
            }

            // Show feedback section only after bond is completed
            const feedbackSection = document.getElementById('feedback-section');
            if (bond.status !== 'active') {
              feedbackSection.classList.remove('hidden');
            } else {
              feedbackSection.classList.add('hidden');
            }

            // Show break button only if bond is active
            const breakBtn = document.getElementById('bond-break-btn');
            if (bond.status === 'active') {
              breakBtn.classList.remove('hidden');
            } else {
              breakBtn.classList.add('hidden');
            }

            // Switch to shared-bond page
            switchPage('shared-bond', null);
            
          }).catch(err => {
            console.error('Error loading bond details:', err);
            alert('Failed to load bond details.');
          });
        }

        function closeBondInterface() {
          document.getElementById('shared-bond').classList.add('hidden');
          switchPage('bond-history', null);
        }

        function openBondChat() {
          const partnerName = document.getElementById('bond-partner-name').textContent;
          openDM(partnerName);
        }

        function breakBondFromInterface() {
          if (!currentBondId) return;
          
          const reason = prompt('Why are you ending this bond?');
          if (!reason) return;
          
          db.collection('bonds').doc(currentBondId).update({
            status: 'broken',
            bondBreakReason: reason,
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
          }).then(() => {
            alert('Bond ended successfully.');
            closeBondInterface();
            loadBondHistory();
          }).catch(err => {
            console.error('Error breaking bond:', err);
            alert('Failed to end bond. Please try again.');
          });
        }

        function showAssessmentForm() {
          if (!currentBondId) return;

          const score = prompt('Enter assessment score (0-100):', '80');
          if (!score) return;

          const numScore = parseInt(score);
          if (isNaN(numScore) || numScore < 0 || numScore > 100) {
            alert('Please enter a valid score between 0 and 100');
            return;
          }

          const comment = prompt('Add assessment comment (optional):', '');

          db.collection('bonds').doc(currentBondId).update({
            assessmentScore: numScore,
            assessmentSubmittedBy: localStorage.getItem('sx_user'),
            assessmentSubmittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            assessmentComment: comment || ''
          }).then(() => {
            alert('Assessment submitted successfully!');
            viewBondDetails(currentBondId);
          }).catch(err => {
            console.error('Error submitting assessment:', err);
            alert('Failed to submit assessment.');
          });
        }

        function showFeedbackForm() {
          if (!currentBondId) return;

          const rating = prompt('Rate this bond exchange (1-5 stars):', '5');
          if (!rating) return;

          const numRating = parseInt(rating);
          if (isNaN(numRating) || numRating < 1 || numRating > 5) {
            alert('Please enter a rating between 1 and 5');
            return;
          }

          const comment = prompt('Share your feedback (optional):', '');

          db.collection('bonds').doc(currentBondId).update({
            feedback: {
              rating: numRating,
              comment: comment || '',
              submittedBy: localStorage.getItem('sx_user'),
              submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
              isVisible: true
            }
          }).then(() => {
            alert('Feedback submitted successfully!');
            viewBondDetails(currentBondId);
          }).catch(err => {
            console.error('Error submitting feedback:', err);
            alert('Failed to submit feedback.');
          });
        }

        function openUserProfile(userId) {
          window.location.href = `profile.html?uid=${userId}`;
        }
        function loadSeniorProfiles() {
  const container = document.getElementById("seniors-container");
  if (!container) return;
  container.innerHTML = "";
  
  db.collection("users").get().then(snapshot => {
      if (snapshot.empty) {
        container.innerHTML = `<p class="text-gray-400 text-center col-span-full">No users found.</p>`;
        return;
      }
      snapshot.forEach(doc => {
        const user = doc.data();
        const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
        const initial = fullName.charAt(0).toUpperCase();
        
        container.innerHTML += `
          <div onclick="openUserProfile('${doc.id}')" class="glass-card bg-white/60 dark:bg-gray-800/60 p-8 rounded-3xl transition text-center cursor-pointer relative group border border-white/50 dark:border-gray-700">
            
            <div class="w-24 h-24 rounded-full mx-auto mb-5 flex items-center justify-center bg-gradient-to-br from-brand to-purple-600 text-white text-3xl font-bold group-hover:scale-110 transition-transform shadow-lg shadow-brand/20">
              ${initial || "U"}
            </div>
            
            <h3 class="font-bold text-xl text-gray-900 dark:text-white group-hover:text-brand transition-colors">${fullName || "Unnamed User"}</h3>
            <p class="text-xs text-gray-500 mt-1 uppercase tracking-wider font-semibold">${user.university || "University not specified"}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-3 mb-6">${user.role || "Student"}</p>
            
            <button onclick="event.stopPropagation(); openDM('${fullName}')" class="w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white py-2.5 rounded-xl text-sm font-bold hover:bg-brand hover:text-white dark:hover:bg-brand transition shadow-sm">Connect</button>
          </div>
        `;
      });
    }).catch(err => {
      console.error(err);
      container.innerHTML = `<p class="text-red-500 text-center col-span-full">Failed to load users.</p>`;
    });
}

        const username = dynamicUsername || "google";
        function extractGitHubUsername(input) {
          if (!input) return "google";
          if (input.includes("github.com")) {
            return input.replace("https://", "").replace("http://", "").replace("github.com/", "").replace("www.github.com/", "").split("/")[0].trim();
          }
          return input.trim();
        }

        async function loadGitHubRepos(dynamicUsername) {
          const username = extractGitHubUsername(dynamicUsername);
          const container = document.getElementById("github-repo-list");
          const profileLink = document.getElementById("github-profile-link");
          if (!container) return;
          profileLink.href = `https://github.com/${username}`;
          const CACHE_KEY = `github_repos_${username}`;
          const CACHE_TIME_KEY = `github_repos_time_${username}`;
          const CACHE_TTL = 30 * 60 * 1000;
          const now = Date.now();
          const cachedData = localStorage.getItem(CACHE_KEY);
          const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
          if (cachedData && cachedTime && now - cachedTime < CACHE_TTL) {
            renderGitHubRepos(JSON.parse(cachedData));
            return;
          }
          container.innerHTML = `<p class="text-center text-gray-400 text-xs py-4">Loading repositories...</p>`;
          try {
            const response = await fetch(`https://api.github.com/users/${username}/repos?sort=updated&per_page=4`, {
                headers: { "Accept": "application/vnd.github+json", "User-Agent": "SkillXchange-App" }
              });
            if (!response.ok) throw new Error("Rate limited");
            const repos = await response.json();
            localStorage.setItem(CACHE_KEY, JSON.stringify(repos));
            localStorage.setItem(CACHE_TIME_KEY, now.toString());
            renderGitHubRepos(repos);
          } catch (err) {
            if (cachedData) {
              renderGitHubRepos(JSON.parse(cachedData));
            } else {
              container.innerHTML = `
                <div class="p-4 text-center">
                  <p class="text-xs text-gray-400">GitHub rate limit reached.</p>
                  <a href="https://github.com/${username}" target="_blank" class="text-xs font-bold underline">Visit Profile</a>
                </div>
              `;
            }
          }
        }
        function renderGitHubRepos(repos) {
          const container = document.getElementById("github-repo-list");
          if (!container) return;
          container.innerHTML = "";
          const langColors = { JavaScript: "bg-yellow-400", TypeScript: "bg-blue-500", HTML: "bg-orange-500", CSS: "bg-blue-400", Python: "bg-green-500", Java: "bg-red-500" };
          repos.forEach(repo => {
            const dotColor = langColors[repo.language] || "bg-gray-400";
            container.innerHTML += `
              <a href="${repo.html_url}" target="_blank" class="px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 hover:bg-white/50 dark:hover:bg-white/10 block transition">
                <div class="flex justify-between items-start">
                  <h4 class="text-sm font-bold text-brand truncate pr-2">${repo.name}</h4>
                  <div class="flex items-center text-gray-400 text-xs">
                    <i class="far fa-star mr-1"></i> ${repo.stargazers_count}
                  </div>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 mb-2 line-clamp-2 leading-relaxed">${repo.description || "No description provided."}</p>
                <div class="flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full ${dotColor}"></span>
                  <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">${repo.language || "Code"}</span>
                </div>
              </a>
            `;
          });
        }

        /* ============ KEYWORD-BASED SEARCH & MATCHING ============ */

        // Perform keyword-based search in offering posts
        async function performKeywordSearch() {
          const searchInput = document.getElementById('keyword-search-offering').value.trim();
          const resultsContainer = document.getElementById('keyword-search-results');

          if (!searchInput) {
            resultsContainer.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">Enter a skill to search</p>';
            return;
          }

          resultsContainer.innerHTML = '<p class="text-xs text-gray-400 text-center py-4 animate-pulse">Searching...</p>';

          try {
            // Get all offering posts from database
            const snapshot = await db.collection('questions')
              .where('tag', '==', 'Offering Skill')
              .get();

            const searchResults = [];
            const normalizedSearch = normalizeSkill(searchInput);

            snapshot.forEach(doc => {
              const data = doc.data();
              const skillsToOffer = (data.skillsToOffer || []).map(s => normalizeSkill(s));
              const skillsToLearn = (data.skillsToLearn || []).map(s => normalizeSkill(s));

              // Search for skill matches in both offering and learning arrays
              const offeringMatches = skillsToOffer.filter(skill => 
                skill.includes(normalizedSearch) || normalizedSearch.includes(skill)
              );
              
              const learningMatches = skillsToLearn.filter(skill => 
                skill.includes(normalizedSearch) || normalizedSearch.includes(skill)
              );

              if (offeringMatches.length > 0 || learningMatches.length > 0) {
                searchResults.push({
                  id: doc.id,
                  ...data,
                  matchType: offeringMatches.length > 0 ? 'offering' : 'learning',
                  matchedSkills: offeringMatches.length > 0 ? offeringMatches : learningMatches,
                  originalSkills: data.skillsToOffer || []
                });
              }
            });

            // Display results
            if (searchResults.length === 0) {
              resultsContainer.innerHTML = `<p class="text-xs text-gray-400 text-center py-4">No matches found for "${searchInput}"</p>`;
              return;
            }

            resultsContainer.innerHTML = searchResults.map(result => {
              const isMe = result.author === localStorage.getItem('sx_user');
              const matchTypeLabel = result.matchType === 'offering' ? 'üéì Offers' : 'üìö Wants';
              
              return `
                <div class="p-3 bg-brand/5 dark:bg-brand/10 border border-brand/20 dark:border-brand/30 rounded-lg hover:bg-brand/10 dark:hover:bg-brand/20 transition cursor-pointer" onclick="navigateToUser('${result.author}')">
                  <div class="flex items-start justify-between mb-2">
                    <div>
                      <p class="text-xs font-bold text-gray-800 dark:text-white">${result.author}</p>
                      <span class="text-[10px] text-brand font-semibold">${matchTypeLabel}</span>
                    </div>
                    ${isMe ? '<span class="text-[10px] text-gray-400">You</span>' : ''}
                  </div>
                  <div class="flex flex-wrap gap-1">
                    ${result.matchedSkills.slice(0, 3).map(skill => 
                      `<span class="text-[10px] px-2 py-1 bg-brand/20 text-brand dark:text-brand rounded-full font-medium">${skill}</span>`
                    ).join('')}
                    ${result.matchedSkills.length > 3 ? `<span class="text-[10px] text-gray-500">+${result.matchedSkills.length - 3}</span>` : ''}
                  </div>
                </div>
              `;
            }).join('');

          } catch (error) {
            console.error('Error searching keywords:', error);
            resultsContainer.innerHTML = '<p class="text-xs text-red-500 text-center py-4">Error searching. Please try again.</p>';
          }
        }

        // Navigate to user profile
        function navigateToUser(username) {
          localStorage.setItem('selectedUser', username);
          switchPage('profile', document.querySelector('[onclick*="profile"]'));
        }

        // Get all unique skills from offering posts for autocomplete suggestions
        async function getSkillSuggestions() {
          try {
            const snapshot = await db.collection('questions')
              .where('tag', '==', 'Offering Skill')
              .get();

            const allSkills = new Set();
            snapshot.forEach(doc => {
              const data = doc.data();
              (data.skillsToOffer || []).forEach(skill => allSkills.add(normalizeSkill(skill)));
              (data.skillsToLearn || []).forEach(skill => allSkills.add(normalizeSkill(skill)));
            });

            return Array.from(allSkills).sort();
          } catch (error) {
            console.error('Error getting skill suggestions:', error);
            return [];
          }
        }

        // Cross-match users based on their offering and learning skills
        async function findCrossMatches(userOffering, userLearning) {
          try {
            const snapshot = await db.collection('questions')
              .where('tag', '==', 'Offering Skill')
              .get();

            const potentialMatches = [];

            snapshot.forEach(doc => {
              const data = doc.data();
              
              // Don't match with own posts
              if (data.author === localStorage.getItem('sx_user')) return;

              const otherOffering = (data.skillsToOffer || []).map(s => normalizeSkill(s));
              const otherLearning = (data.skillsToLearn || []).map(s => normalizeSkill(s));

              let matchScore = 0;
              const matchDetails = [];

              // Check if user's offerings match other's learning
              userOffering.forEach(mySkill => {
                const normalized = normalizeSkill(mySkill);
                if (otherLearning.some(otherSkill => 
                  otherSkill.includes(normalized) || normalized.includes(otherSkill)
                )) {
                  matchScore += 2;
                  matchDetails.push(`They want to learn ${mySkill}`);
                }
              });

              // Check if user's learning matches other's offerings
              userLearning.forEach(myWant => {
                const normalized = normalizeSkill(myWant);
                if (otherOffering.some(otherSkill => 
                  otherSkill.includes(normalized) || normalized.includes(otherSkill)
                )) {
                  matchScore += 2;
                  matchDetails.push(`They can teach ${myWant}`);
                }
              });

              if (matchScore > 0) {
                potentialMatches.push({
                  id: doc.id,
                  ...data,
                  matchScore,
                  matchDetails
                });
              }
            });

            // Sort by match score (highest first)
            return potentialMatches.sort((a, b) => b.matchScore - a.matchScore);
          } catch (error) {
            console.error('Error finding cross matches:', error);
            return [];
          }
        }

        // Enhanced filter with keyword support
        async function filterOfferingPostsByKeyword(keyword) {
          try {
            const snapshot = await db.collection('questions')
              .where('tag', '==', 'Offering Skill')
              .get();

            const normalizedKeyword = normalizeSkill(keyword);
            const filtered = [];

            snapshot.forEach(doc => {
              const data = doc.data();
              const skills = [
                ...(data.skillsToOffer || []),
                ...(data.skillsToLearn || []),
                data.title || ''
              ];

              // Check if any skill contains the keyword
              if (skills.some(skill => {
                const normalized = normalizeSkill(skill.toString());
                return normalized.includes(normalizedKeyword) || normalizedKeyword.includes(normalized);
              })) {
                filtered.push({ id: doc.id, ...data });
              }
            });

            return filtered;
          } catch (error) {
            console.error('Error filtering by keyword:', error);
            return [];
          }
        }

        /* ============ BOND SYSTEM - SKILL EXCHANGE WORKFLOW ============ */

        // Bond States: 'active', 'completed', 'bond_break'
        // Roles: 'tutor', 'learner'

        // Bond Data Model
        /*
        {
          id: unique,
          postId: string,
          tutorId: string,
          learnerId: string,
          skillOffered: string,
          skillLearned: string,
          status: 'active' | 'completed' | 'bond_break',
          createdAt: timestamp,
          completedAt: timestamp,
          assessmentScore: number (0-100),
          assessmentSubmittedBy: tutorId,
          assessmentSubmittedAt: timestamp,
          feedback: {
            rating: 1-5,
            comment: string,
            submittedAt: timestamp,
            isVisible: boolean (based on assessment completion)
          },
          bondBreakReason: string (if bond_break)
        }
        */

        // Initiate a new bond
        async function initiateBond(postId, tutorId) {
          const currentUser = localStorage.getItem('sx_user');
          
          if (!currentUser) {
            alert('Please log in to create a bond');
            return;
          }

          if (currentUser === tutorId) {
            alert("You can't create a bond with yourself");
            return;
          }

          // Check if request or active bond already exists
          const existingRequest = await checkExistingBondRequest(tutorId, currentUser);
          if (existingRequest) {
            alert('A bond request already exists between you two');
            return;
          }

          // Show bond request confirmation modal
          showBondRequestModal(postId, tutorId);
        }

        // Check if bond request or bond already exists
        async function checkExistingBondRequest(tutorId, learnerId) {
          try {
            const bondReq = await db.collection('bond_requests')
              .where('tutorId', '==', tutorId)
              .where('learnerId', '==', learnerId)
              .where('status', '==', 'pending')
              .get();

            if (!bondReq.empty) return true;

            // Also check for active bond
            const activeBond = await db.collection('bonds')
              .where('tutorId', '==', tutorId)
              .where('learnerId', '==', learnerId)
              .where('status', '==', 'active')
              .get();

            return !activeBond.empty;
          } catch (error) {
            console.error('Error checking bond request:', error);
            return false;
          }
        }

        // Show bond request confirmation modal
        function showBondRequestModal(postId, tutorId) {
          const currentUser = localStorage.getItem('sx_user');
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 p-6">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-handshake text-brand mr-2"></i>Send Bond Request
              </h2>
              <p class="text-gray-600 dark:text-gray-300 mb-6">
                A bond request will be sent to <strong>${tutorId}</strong>. They can accept or reject your request. Once accepted, you can start your skill exchange.
              </p>
              
              <div class="bg-brandLight/20 dark:bg-brand/10 border border-brand/30 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  <strong>To:</strong> ${tutorId}<br>
                  <strong>From:</strong> ${currentUser}
                </p>
              </div>

              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  Cancel
                </button>
                <button onclick="sendBondRequest('${postId}', '${tutorId}'); this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg bg-brand text-white font-semibold hover:bg-brandDark transition">
                  Send Request
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Send a bond request (not creating bond yet)
        async function sendBondRequest(postId, tutorId) {
          const currentUser = localStorage.getItem('sx_user');
          
          try {
            // Get post data to extract skills
            const postDoc = await db.collection('questions').doc(postId).get();
            if (!postDoc.exists) {
              alert('Post not found');
              return;
            }

            const postData = postDoc.data();
            const skillOffered = (postData.skillsToOffer && postData.skillsToOffer[0]) || 'Skill Exchange';
            const skillLearned = (postData.skillsToLearn && postData.skillsToLearn[0]) || 'Unknown Skill';

            // Create bond request (NOT a full bond yet)
            await db.collection('bond_requests').add({
              postId: postId,
              tutorId: tutorId,
              learnerId: currentUser,
              skillOffered: skillOffered,
              skillLearned: skillLearned,
              status: 'pending', // pending, accepted, rejected
              sentAt: firebase.firestore.FieldValue.serverTimestamp(),
              respondedAt: null,
              response: null
            });

            alert('Bond request sent! Waiting for response...');

          } catch (error) {
            console.error('Error sending bond request:', error);
            alert('Failed to send request. Please try again.');
          }
        }

        // Accept a bond request
        async function acceptBondRequest(requestId) {
          const currentUser = localStorage.getItem('sx_user');
          
          try {
            const reqDoc = await db.collection('bond_requests').doc(requestId).get();
            if (!reqDoc.exists) {
              alert('Request not found');
              return;
            }

            const request = reqDoc.data();
            
            // Verify current user is the recipient (tutor)
            if (request.tutorId !== currentUser) {
              alert('You can only respond to requests sent to you');
              return;
            }

            // Now create the actual bond
            const bondRef = await db.collection('bonds').add({
              postId: request.postId,
              tutorId: request.tutorId,
              learnerId: request.learnerId,
              skillOffered: request.skillOffered,
              skillLearned: request.skillLearned,
              status: 'active',
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              requestId: requestId,
              completedAt: null,
              assessmentScore: null,
              assessmentSubmittedBy: null,
              assessmentSubmittedAt: null,
              feedback: null,
              bondBreakReason: null
            });

            // Update request status
            await db.collection('bond_requests').doc(requestId).update({
              status: 'accepted',
              respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
              response: 'accepted',
              bondId: bondRef.id
            });

            alert('Bond request accepted! Starting skill exchange...');
            location.reload();

          } catch (error) {
            console.error('Error accepting bond request:', error);
            alert('Failed to accept request. Please try again.');
          }
        }

        // Reject a bond request
        async function rejectBondRequest(requestId) {
          const currentUser = localStorage.getItem('sx_user');
          
          try {
            const reqDoc = await db.collection('bond_requests').doc(requestId).get();
            if (!reqDoc.exists) {
              alert('Request not found');
              return;
            }

            const request = reqDoc.data();
            
            // Verify current user is the recipient (tutor)
            if (request.tutorId !== currentUser) {
              alert('You can only respond to requests sent to you');
              return;
            }

            // Update request status to rejected
            await db.collection('bond_requests').doc(requestId).update({
              status: 'rejected',
              respondedAt: firebase.firestore.FieldValue.serverTimestamp(),
              response: 'rejected'
            });

            alert('Bond request rejected');
            location.reload();

          } catch (error) {
            console.error('Error rejecting bond request:', error);
            alert('Failed to reject request. Please try again.');
          }
        }

        // Create a new bond in Firestore (kept for backwards compatibility)
        async function createBond(postId, tutorId) {
          // This function is now replaced by the request-response flow
          // But keeping for backwards compatibility
          await sendBondRequest(postId, tutorId);
        }

        // Submit assessment (tutor only)
        async function submitAssessment(bondId, score) {
          const currentUser = localStorage.getItem('sx_user');
          
          if (!score || score < 0 || score > 100) {
            alert('Please enter a valid score between 0 and 100');
            return;
          }

          try {
            const bondDoc = await db.collection('bonds').doc(bondId).get();
            if (!bondDoc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = bondDoc.data();
            if (bond.tutorId !== currentUser) {
              alert('Only the tutor can submit assessment');
              return;
            }

            // Update bond with assessment
            await db.collection('bonds').doc(bondId).update({
              assessmentScore: parseInt(score),
              assessmentSubmittedBy: currentUser,
              assessmentSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Assessment submitted successfully!');
            location.reload();

          } catch (error) {
            console.error('Error submitting assessment:', error);
            alert('Failed to submit assessment');
          }
        }

        // Submit feedback (learner only)
        async function submitFeedback(bondId, rating, comment) {
          const currentUser = localStorage.getItem('sx_user');

          if (!rating || rating < 1 || rating > 5) {
            alert('Please provide a rating between 1 and 5 stars');
            return;
          }

          try {
            const bondDoc = await db.collection('bonds').doc(bondId).get();
            if (!bondDoc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = bondDoc.data();
            if (bond.learnerId !== currentUser) {
              alert('Only the learner can submit feedback');
              return;
            }

            // Check if assessment is submitted (for active/completed bonds)
            const isAssessmentSubmitted = bond.assessmentScore !== null && bond.status === 'active';

            // Update bond with feedback
            await db.collection('bonds').doc(bondId).update({
              feedback: {
                rating: parseInt(rating),
                comment: comment,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                isVisible: isAssessmentSubmitted || bond.status === 'bond_break'
              }
            });

            alert('Feedback submitted successfully!');
            location.reload();

          } catch (error) {
            console.error('Error submitting feedback:', error);
            alert('Failed to submit feedback');
          }
        }

        // Complete bond (transition from active to completed)
        async function completeBond(bondId) {
          const currentUser = localStorage.getItem('sx_user');

          try {
            const bondDoc = await db.collection('bonds').doc(bondId).get();
            if (!bondDoc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = bondDoc.data();
            if (bond.tutorId !== currentUser) {
              alert('Only the tutor can complete the bond');
              return;
            }

            if (bond.status !== 'active') {
              alert('Bond cannot be completed in its current state');
              return;
            }

            // Update bond status to completed
            await db.collection('bonds').doc(bondId).update({
              status: 'completed',
              completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update tutor's completed courses
            await updateTutorStats(bond.tutorId);

            alert('Bond marked as completed!');
            location.reload();

          } catch (error) {
            console.error('Error completing bond:', error);
            alert('Failed to complete bond');
          }
        }

        // Initiate mutual bond break
        async function initiateBondBreak(bondId, reason = '') {
          const currentUser = localStorage.getItem('sx_user');

          try {
            const bondDoc = await db.collection('bonds').doc(bondId).get();
            if (!bondDoc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = bondDoc.data();
            if (bond.status !== 'active') {
              alert('Only active bonds can be broken');
              return;
            }

            // Show bond break confirmation modal
            showBondBreakModal(bondId, reason);

          } catch (error) {
            console.error('Error initiating bond break:', error);
          }
        }

        // Show bond break confirmation modal
        function showBondBreakModal(bondId, defaultReason = '') {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 p-6">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-link-slash text-red-500 mr-2"></i>Discontinue Bond
              </h2>
              <p class="text-gray-600 dark:text-gray-300 mb-4">
                Both users must agree to discontinue this bond. Assessment will be skipped, but feedback can still be submitted.
              </p>
              
              <textarea placeholder="Reason for bond break (optional)" 
                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 text-sm dark:bg-gray-700 dark:text-white mb-4 focus:ring-2 focus:ring-brand outline-none" 
                        id="break-reason" 
                        rows="3">${defaultReason}</textarea>

              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  Cancel
                </button>
                <button onclick="confirmBondBreak('${bondId}', document.getElementById('break-reason').value); this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">
                  Confirm Break
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Confirm and execute bond break
        async function confirmBondBreak(bondId, reason) {
          const currentUser = localStorage.getItem('sx_user');

          try {
            await db.collection('bonds').doc(bondId).update({
              status: 'bond_break',
              bondBreakReason: reason,
              completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Bond discontinued. Both users can now submit optional feedback.');
            location.reload();

          } catch (error) {
            console.error('Error breaking bond:', error);
            alert('Failed to discontinue bond');
          }
        }

        // Load bond history in profile
        async function loadBondHistory() {
          const currentUser = localStorage.getItem('sx_user');
          const container = document.getElementById('bond-history-container');

          if (!container) return;

          try {
            const snapshot = await db.collection('bonds')
              .where('tutorId', '==', currentUser)
              .get();

            const bonds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (bonds.length === 0) {
              container.innerHTML = '<p class="text-gray-400 text-sm">No bond history yet</p>';
              return;
            }

            let html = '';
            bonds.forEach(bond => {
              const statusColors = {
                'active': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
                'completed': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300',
                'bond_break': 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
              };

              const createdDate = bond.createdAt ? new Date(bond.createdAt.toDate()).toLocaleDateString() : 'N/A';

              html += `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <p class="font-semibold text-gray-800 dark:text-white">${bond.skillOffered} ‚Üî ${bond.skillLearned}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">Learner: ${bond.learnerId}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[bond.status] || statusColors.active}">
                      ${bond.status.replace('_', ' ').toUpperCase()}
                    </span>
                  </div>
                  <p class="text-xs text-gray-500 mb-3">Started: ${createdDate}</p>
                  ${bond.assessmentScore !== null ? `
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      <i class="fas fa-star text-yellow-500 mr-1"></i>Assessment Score: ${bond.assessmentScore}/100
                    </p>
                  ` : ''}
                  ${bond.feedback ? `
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                      <i class="fas fa-star text-yellow-500 mr-1"></i>Rating: ${'‚≠ê'.repeat(bond.feedback.rating)}
                    </p>
                  ` : ''}
                </div>
              `;
            });

            container.innerHTML = html;

          } catch (error) {
            console.error('Error loading bond history:', error);
            container.innerHTML = '<p class="text-red-500 text-sm">Error loading bonds</p>';
          }
        }

        // Update tutor statistics (completed courses, badges)
        async function updateTutorStats(tutorId) {
          try {
            // Get completed courses count
            const completedSnapshot = await db.collection('bonds')
              .where('tutorId', '==', tutorId)
              .where('status', '==', 'completed')
              .get();

            const completedCount = completedSnapshot.size;

            // Get average rating
            let totalRating = 0;
            let ratingCount = 0;

            completedSnapshot.forEach(doc => {
              const bond = doc.data();
              if (bond.feedback && bond.feedback.isVisible) {
                totalRating += bond.feedback.rating;
                ratingCount++;
              }
            });

            const avgRating = ratingCount > 0 ? totalRating / ratingCount : 0;

            // Determine badges
            let badges = [];
            if (avgRating >= 3.5) {
              if (completedCount >= 5) badges.push('silver');
              if (completedCount >= 10) badges.push('gold');
              if (completedCount >= 15) badges.push('platinum');
            }

            // Update user profile with stats
            await db.collection('users').doc(tutorId).update({
              completedCourses: completedCount,
              averageRating: avgRating,
              badges: badges
            });

          } catch (error) {
            console.error('Error updating tutor stats:', error);
          }
        }

        // Display tutor badges
        function displayBadges(badges = []) {
          const badgeIcons = {
            'silver': '<i class="fas fa-medal text-gray-400 text-xl" title="Silver - 5 courses"></i>',
            'gold': '<i class="fas fa-medal text-yellow-500 text-xl" title="Gold - 10 courses"></i>',
            'platinum': '<i class="fas fa-crown text-blue-500 text-xl" title="Platinum - 15 courses"></i>'
          };

          return badges.map(badge => badgeIcons[badge] || '').join(' ');
        }

        // Show assessment modal (tutor only)
        function showAssessmentModal(bondId) {
          const currentUser = localStorage.getItem('sx_user');
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 p-6">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-clipboard-list text-brand mr-2"></i>Course Assessment
              </h2>
              <p class="text-gray-600 dark:text-gray-300 mb-6">
                Evaluate the learner's understanding and mastery of the course material.
              </p>
              
              <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                  Assessment Score (0-100)
                </label>
                <div class="flex items-center gap-3">
                  <input type="range" id="score-slider" min="0" max="100" value="75" 
                         class="flex-1 h-2 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-lg appearance-none cursor-pointer accent-brand"
                         oninput="document.getElementById('score-display').textContent = this.value">
                  <span id="score-display" class="text-3xl font-bold text-brand w-14 text-right">75</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-2">
                  <span>Poor (0)</span>
                  <span>Good (50)</span>
                  <span>Excellent (100)</span>
                </div>
              </div>

              <textarea placeholder="Assessment feedback (optional)" 
                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 text-sm dark:bg-gray-700 dark:text-white mb-6 focus:ring-2 focus:ring-brand outline-none" 
                        id="assessment-feedback" 
                        rows="3"></textarea>

              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  Cancel
                </button>
                <button onclick="submitAssessment('${bondId}', document.getElementById('score-slider').value); this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg bg-brand text-white font-semibold hover:bg-brandDark transition">
                  Submit Assessment
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Show feedback modal (learner only)
        function showFeedbackModal(bondId) {
          const currentUser = localStorage.getItem('sx_user');
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 p-6">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                <i class="fas fa-star text-yellow-500 mr-2"></i>Course Feedback
              </h2>
              <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">
                Share your experience and rate your tutor's teaching quality.
              </p>
              
              <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                  Rating
                </label>
                <div class="flex gap-2" id="rating-container">
                  <button class="star-btn text-4xl text-gray-300 hover:text-yellow-500 transition cursor-pointer" data-rating="1" onclick="selectRating(1)">‚≠ê</button>
                  <button class="star-btn text-4xl text-gray-300 hover:text-yellow-500 transition cursor-pointer" data-rating="2" onclick="selectRating(2)">‚≠ê</button>
                  <button class="star-btn text-4xl text-gray-300 hover:text-yellow-500 transition cursor-pointer" data-rating="3" onclick="selectRating(3)">‚≠ê</button>
                  <button class="star-btn text-4xl text-gray-300 hover:text-yellow-500 transition cursor-pointer" data-rating="4" onclick="selectRating(4)">‚≠ê</button>
                  <button class="star-btn text-4xl text-gray-300 hover:text-yellow-500 transition cursor-pointer" data-rating="5" onclick="selectRating(5)">‚≠ê</button>
                </div>
                <input type="hidden" id="selected-rating" value="0">
              </div>

              <textarea placeholder="Share your feedback about the course and teaching quality..." 
                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-3 text-sm dark:bg-gray-700 dark:text-white mb-6 focus:ring-2 focus:ring-brand outline-none" 
                        id="feedback-comment" 
                        rows="4"></textarea>

              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  Cancel
                </button>
                <button onclick="submitFeedback('${bondId}', document.getElementById('selected-rating').value, document.getElementById('feedback-comment').value); this.closest('.fixed').remove()" 
                        class="flex-1 px-4 py-3 rounded-lg bg-brand text-white font-semibold hover:bg-brandDark transition">
                  Submit Feedback
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Helper function to select rating
        function selectRating(rating) {
          document.getElementById('selected-rating').value = rating;
          const stars = document.querySelectorAll('.star-btn');
          stars.forEach((star, index) => {
            if (index < rating) {
              star.classList.add('text-yellow-500');
              star.classList.remove('text-gray-300');
            } else {
              star.classList.remove('text-yellow-500');
              star.classList.add('text-gray-300');
            }
          });
        }

        /* ============ GOOGLE FORMS INTEGRATION ============ */

        // Show modal to attach or create assessment form
        function showAttachFormModal(bondId) {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-white/20 p-6">
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-wpforms text-purple-600 mr-2"></i>Add Assessment Form
              </h2>
              
              <div class="space-y-4">
                <!-- Option 1: Create new form -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                    <i class="fas fa-plus text-green-600 mr-2"></i>Create New Form
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Create a new Google Form integrated with this bond
                  </p>
                  <div class="space-y-3">
                    <input type="text" placeholder="Form Title" id="form-title" 
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none">
                    <textarea placeholder="Form Description (optional)" id="form-description" rows="2"
                              class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
                    <select id="form-template" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
                      <option value="">Select Template (optional)</option>
                      <option value="general">General Assessment</option>
                      <option value="coding">Coding Challenge</option>
                      <option value="essay">Essay Question</option>
                    </select>
                    <button onclick="createAndAttachForm('${bondId}')"
                            class="w-full px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition">
                      <i class="fas fa-magic mr-1"></i>Create Form
                    </button>
                  </div>
                </div>

                <div class="relative">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                  </div>
                  <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white dark:bg-gray-800 text-gray-500">OR</span>
                  </div>
                </div>

                <!-- Option 2: Attach existing form -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-2">
                    <i class="fas fa-link text-blue-600 mr-2"></i>Attach Existing Form
                  </h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Use a Google Form you've already created
                  </p>
                  <div class="space-y-3">
                    <input type="text" placeholder="Paste form URL or ID" id="existing-form-id"
                           class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                           title="Paste the Google Form URL or Form ID">
                    <small class="text-gray-500 block">
                      Example: https://docs.google.com/forms/d/1ABC...../viewform
                    </small>
                    <button onclick="attachExistingForm('${bondId}')"
                            class="w-full px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
                      <i class="fas fa-check mr-1"></i>Attach Form
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                <button onclick="this.closest('.fixed').remove()"
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  Cancel
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }

        // Create a new Google Form for assessment
        async function createAndAttachForm(bondId) {
          const title = document.getElementById('form-title')?.value?.trim();
          const description = document.getElementById('form-description')?.value?.trim();
          const template = document.getElementById('form-template')?.value;

          if (!title) {
            alert('Please enter a form title');
            return;
          }

          try {
            // Show loading state
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating form...';

            // Get template questions
            let questions = [];
            if (template) {
              questions = googleFormsService.createTemplateQuestions(template);
            }

            // Call Cloud Function to create form
            const result = await googleFormsService.createAssessmentForm(
              bondId,
              title,
              description,
              questions
            );

            alert(`Form created successfully! URL: ${result.formUrl}`);
            
            // Close modal and refresh bond details
            document.querySelector('.fixed').remove();
            location.reload();

          } catch (error) {
            console.error('Error creating form:', error);
            alert(`Failed to create form: ${error.message}`);
            
            // Reset button
            const btn = event.target;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic mr-1"></i>Create Form';
          }
        }

        // Attach an existing Google Form to bond
        async function attachExistingForm(bondId) {
          const formInput = document.getElementById('existing-form-id')?.value?.trim();

          if (!formInput) {
            alert('Please enter a form URL or ID');
            return;
          }

          try {
            // Extract form ID from URL or use as-is
            const formId = googleFormsService.extractFormId(formInput);
            
            if (!formId) {
              alert('Invalid form URL or ID format');
              return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Attaching...';

            // Call Cloud Function to attach form
            const result = await googleFormsService.attachAssessmentForm(bondId, formId);

            alert('Form attached successfully!');
            
            // Close modal and refresh
            document.querySelector('.fixed').remove();
            location.reload();

          } catch (error) {
            console.error('Error attaching form:', error);
            alert(`Failed to attach form: ${error.message}`);
            
            // Reset button
            const btn = event.target;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check mr-1"></i>Attach Form';
          }
        }

        // Open form responses modal for tutor
        async function showFormResponsesModal(bondId) {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl border border-white/20 p-6 max-h-96 overflow-y-auto">
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                  <i class="fas fa-chart-bar text-purple-600 mr-2"></i>Form Responses
                </h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div id="responses-container" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2 block"></i>
                <p class="text-gray-500">Loading responses...</p>
              </div>

              <div class="mt-4 flex gap-2">
                <button onclick="this.closest('.fixed').remove()"
                        class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold">
                  Close
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          try {
            // Fetch responses
            const responseData = await googleFormsService.getFormResponses(bondId);
            const container = document.getElementById('responses-container');

            if (responseData.responses && responseData.responses.length > 0) {
              container.innerHTML = `
                <div class="text-left">
                  <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">
                    Total Submissions: <span class="text-purple-600">${responseData.submissionCount}</span>
                  </p>
                  <div class="space-y-3 max-h-64 overflow-y-auto">
                    ${responseData.responses.map((response, idx) => `
                      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Submission ${idx + 1}</p>
                        <p class="text-xs text-gray-500 mt-1">
                          Submitted: ${new Date(response.createTime).toLocaleDateString()}
                        </p>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            } else {
              container.innerHTML = `
                <p class="text-gray-500">
                  <i class="fas fa-inbox text-2xl mb-2 block opacity-50"></i>
                  No responses yet
                </p>
              `;
            }
          } catch (error) {
            console.error('Error loading responses:', error);
            const container = document.getElementById('responses-container');
            container.innerHTML = `
              <p class="text-red-500">
                <i class="fas fa-exclamation-circle text-2xl mb-2 block"></i>
                Failed to load responses: ${error.message}
              </p>
            `;
          }
        }

        // Open form in new tab
        function openFormInNewTab(formId) {
          const formUrl = `https://docs.google.com/forms/d/${formId}/viewform`;
          window.open(formUrl, '_blank', 'noopener,noreferrer');
          
          // Track event
          const bondId = event.target.closest('.fixed')?.parentElement?.getAttribute('data-bond-id') || '';
          if (bondId && googleFormsService) {
            googleFormsService.trackFormEvent(bondId, formId, 'form_opened');
          }
        }

        // Show bond details modal with actions
        async function showBondDetails(bondId) {
          const currentUser = localStorage.getItem('sx_user');
          
          try {
            const bondDoc = await db.collection('bonds').doc(bondId).get();
            if (!bondDoc.exists) {
              alert('Bond not found');
              return;
            }

            const bond = bondDoc.data();
            const isTutor = bond.tutorId === currentUser;
            const isLearner = bond.learnerId === currentUser;

            const createdDate = bond.createdAt 
              ? new Date(bond.createdAt.toDate()).toLocaleDateString() 
              : 'N/A';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-900/60 backdrop-blur-md flex items-center justify-center z-50 p-4';
            
            let actionButtons = '';
            
            if (bond.status === 'active') {
              if (isTutor && bond.assessmentScore === null) {
                actionButtons += `
                  <button onclick="showAssessmentModal('${bondId}')" 
                          class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
                    <i class="fas fa-clipboard-list mr-2"></i>Submit Assessment
                  </button>
                `;
              }
              
              if (isLearner && bond.assessmentScore !== null && !bond.feedback) {
                actionButtons += `
                  <button onclick="showFeedbackModal('${bondId}')" 
                          class="flex-1 px-4 py-2 rounded-lg bg-yellow-600 text-white font-semibold hover:bg-yellow-700 transition">
                    <i class="fas fa-star mr-2"></i>Submit Feedback
                  </button>
                `;
              }

              if (isTutor && bond.assessmentScore !== null && bond.feedback) {
                actionButtons += `
                  <button onclick="completeBond('${bondId}')" 
                          class="flex-1 px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition">
                    <i class="fas fa-check-circle mr-2"></i>Mark Completed
                  </button>
                `;
              }

              actionButtons += `
                <button onclick="initiateBondBreak('${bondId}')" 
                        class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition">
                  <i class="fas fa-link-slash mr-2"></i>Break Bond
                </button>
              `;
            }

            modal.innerHTML = `
              <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-white/20 p-6">
                <div class="flex justify-between items-start mb-4">
                  <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-handshake text-brand mr-2"></i>Bond Details
                  </h2>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                  </button>
                </div>

                <div class="space-y-4 mb-6">
                  <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Skills Exchange</p>
                    <p class="font-bold text-gray-900 dark:text-white">${bond.skillOffered} ‚Üî ${bond.skillLearned}</p>
                  </div>

                  <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                      <p class="text-xs text-gray-500 dark:text-gray-400">Tutor</p>
                      <p class="font-semibold text-gray-900 dark:text-white text-sm">${bond.tutorId}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                      <p class="text-xs text-gray-500 dark:text-gray-400">Learner</p>
                      <p class="font-semibold text-gray-900 dark:text-white text-sm">${bond.learnerId}</p>
                    </div>
                  </div>

                  <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Status</p>
                    <p class="font-bold text-gray-900 dark:text-white text-lg">
                      ${bond.status === 'active' ? '<span class="text-blue-600">üîµ Active</span>' : 
                        bond.status === 'completed' ? '<span class="text-green-600">‚úÖ Completed</span>' : 
                        '<span class="text-red-600">‚õî Bond Break</span>'}
                    </p>
                  </div>

                  <div class="text-xs text-gray-500 dark:text-gray-400">
                    Created: ${createdDate}
                  </div>

                  ${bond.assessmentScore !== null ? `
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                      <p class="text-sm font-semibold text-blue-900 dark:text-blue-300">
                        <i class="fas fa-star text-yellow-500 mr-1"></i>Assessment Score: ${bond.assessmentScore}/100
                      </p>
                    </div>
                  ` : ''}

                  ${bond.feedback ? `
                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                      <p class="text-sm font-semibold text-green-900 dark:text-green-300">
                        <i class="fas fa-star text-yellow-500 mr-1"></i>${'‚≠ê'.repeat(bond.feedback.rating)} (${bond.feedback.rating}/5)
                      </p>
                      ${bond.feedback.isVisible ? `<p class="text-sm text-green-800 dark:text-green-400 mt-2">"${bond.feedback.comment}"</p>` : '<p class="text-sm text-gray-500 mt-2 italic">Feedback locked until assessment submitted</p>'}
                    </div>
                  ` : ''}

                  <!-- Google Forms Assessment Section -->
                  ${bond.assessmentForm ? `
                    <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                      <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold text-purple-900 dark:text-purple-300">
                          <i class="fas fa-wpforms text-purple-600 mr-1"></i>Assessment Form
                        </p>
                        ${isTutor && bond.assessmentForm.status === 'active' ? `
                          <button onclick="showFormResponsesModal('${bondId}')" 
                                  class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 transition">
                            <i class="fas fa-chart-bar mr-1"></i>View Responses
                          </button>
                        ` : ''}
                      </div>
                      <p class="text-xs text-purple-700 dark:text-purple-300 mb-2">${bond.assessmentForm.title}</p>
                      ${isTutor ? `
                        <p class="text-xs text-gray-500">
                          <i class="fas fa-file-signature mr-1"></i>
                          Submissions: ${bond.assessmentForm.submissionCount || 0}
                        </p>
                      ` : `
                        <button onclick="openFormInNewTab('${bond.assessmentForm.formId}')" 
                                class="text-xs text-purple-600 hover:text-purple-700 underline mt-2">
                          <i class="fas fa-external-link-alt mr-1"></i>Open Form
                        </button>
                      `}
                    </div>
                  ` : ''}
                </div>

                <div class="flex gap-2 ${actionButtons ? '' : 'hidden'} flex-wrap">
                  ${actionButtons}
                  ${isTutor && bond.status === 'active' && !bond.assessmentForm ? `
                    <button onclick="showAttachFormModal('${bondId}')" 
                            class="flex-1 px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700 transition text-sm">
                      <i class="fas fa-plus mr-1"></i>Add Form
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);

          } catch (error) {
            console.error('Error showing bond details:', error);
            alert('Failed to load bond details');
          }
        }

    </script>
    
    <div id="project-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-md hidden items-center justify-center z-50 p-4 transition-all">
        <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all border border-white/20">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700/50 flex justify-between items-center bg-gray-50/50 dark:bg-gray-700/30">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Launch Project</h3>
                <button onclick="toggleModal('project-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Project Name</label>
                    <input id="proj-title" class="w-full bg-white/50 dark:bg-gray-700/50 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Description</label>
                    <textarea id="proj-desc" class="w-full bg-white/50 dark:bg-gray-700/50 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl p-3 h-24 resize-none focus:ring-2 focus:ring-brand outline-none shadow-sm"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">GitHub Repository Link</label>
                    <input id="proj-github" placeholder="e.g. https://github.com/username/repo" class="w-full bg-white/50 dark:bg-gray-700/50 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Tech Stack</label>
                    <input id="proj-tags" class="w-full bg-white/50 dark:bg-gray-700/50 dark:text-white border border-gray-200 dark:border-gray-600 rounded-xl p-3 focus:ring-2 focus:ring-brand outline-none shadow-sm">
                </div>
                <button onclick="postProject()" class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition shadow-lg shadow-brand/30 mt-2">Publish Project</button>
            </div>
        </div>
    </div>
    <div id="hackroom-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
  <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-white/20">
    
    <div class="p-6 border-b border-gray-100 dark:border-gray-700/50 flex justify-between items-center">
      <h3 class="text-xl font-bold text-gray-800 dark:text-white">
        Launch HackRoom
      </h3>
      <button onclick="toggleModal('hackroom-modal')" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-6 space-y-5">
      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">
          Hackathon Name
        </label>
        <input id="hack-hackathon" class="input">
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">
          Location / Mode
        </label>
        <input id="hack-location" placeholder="Online / IIT Delhi / Bangalore"
          class="input">
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">
          Project Idea
        </label>
        <textarea id="hack-idea" class="input h-24 resize-none"></textarea>
      </div>

      <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5">
          Looking For (Roles)
        </label>
        <input id="hack-roles" placeholder="Frontend, ML, Backend"
          class="input">
      </div>

      <button onclick="postHackRoom()"
        class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition shadow-lg shadow-brand/30">
        Publish HackRoom
      </button>
    </div>

  </div>
</div>

    <div id="project-details-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-md hidden items-center justify-center z-50 p-4">
      <div class="glass-panel bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh] border border-white/20">
        <div class="bg-gray-50/50 dark:bg-gray-700/50 px-6 py-5 border-b border-gray-100 dark:border-gray-700/50 flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">Project Details</h3>
          <button onclick="toggleModal('project-details-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-8 overflow-y-auto">
          <h2 id="detail-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-2"></h2>
          <div class="flex items-center gap-5 text-sm text-gray-500 dark:text-gray-400 mb-6">
            <span class="flex items-center gap-2"><i class="fas fa-user text-brand"></i> <span id="detail-author" class="font-medium"></span></span>
            <span class="flex items-center gap-2"><i class="far fa-clock text-brand"></i> <span id="detail-date"></span></span>
          </div>
          <div class="mb-8">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">Description</h4>
            <p id="detail-desc" class="text-gray-700 dark:text-gray-300 text-base leading-relaxed whitespace-pre-wrap"></p>
          </div>
          <div class="mb-8">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3 tracking-wider">Tech Stack</h4>
            <div id="detail-tech" class="flex flex-wrap gap-2"></div>
          </div>
          <button id="detail-message-btn" class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition shadow-lg shadow-brand/30"><i class="far fa-comment-alt mr-2"></i> Message Author</button>
        </div>
      </div>
    </div>

</body>
</html>