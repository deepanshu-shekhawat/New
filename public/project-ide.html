<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8" />
<title>Peer2Skill IDE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: { 
                    sans: ['Inter', 'sans-serif'],
                    mono: ['JetBrains Mono', 'monospace']
                },
                colors: {
                    brand: '#6366f1',
                    brandDark: '#4f46e5',
                    editorBg: '#1e1e1e',
                    sidebarBg: '#252526',
                    activityBg: '#333333',
                    borderDark: '#3e3e42'
                }
            }
        }
    }
</script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: #4f4f4f; }
    
    .loading-spinner { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #6366f1; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Resizer Handle Styling */
    .gutter {
        background-color: #e5e7eb; /* Light mode border color */
        cursor: col-resize;
        transition: background-color 0.2s;
        z-index: 10;
        width: 4px;
        flex-shrink: 0;
    }
    html.dark .gutter {
        background-color: #2b2b2b; /* Dark mode border color */
    }
    .gutter:hover, .gutter.dragging {
        background-color: #6366f1 !important; /* Brand color on hover/drag */
    }

    /* Prevent iframe capturing mouse events during drag */
    iframe { pointer-events: auto; }
    body.resizing iframe { pointer-events: none; }
</style>
</head>

<body class="h-screen flex flex-col overflow-hidden bg-gray-100 dark:bg-[#1e1e1e] text-gray-800 dark:text-[#cccccc] font-sans transition-colors duration-300">

<header class="h-12 bg-white dark:bg-[#3c3c3c] border-b border-gray-200 dark:border-black flex items-center justify-between px-4 z-20 shrink-0 shadow-sm">
    <div class="flex items-center gap-4">
        <button onclick="window.location.href='index.html'" class="flex items-center gap-2 text-xs font-semibold text-gray-600 dark:text-gray-300 hover:text-brand dark:hover:text-white transition">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
        <span class="h-4 w-[1px] bg-gray-300 dark:bg-gray-600"></span>
        <div class="flex items-center gap-2">
            <i class="fas fa-code text-brand"></i>
            <span class="font-semibold text-sm tracking-wide" id="project-header-name">SkillXchange IDE</span>
        </div>
    </div>

    <div class="flex items-center gap-3">
        <button onclick="toggleTheme()" class="w-8 h-8 rounded-md hover:bg-gray-100 dark:hover:bg-[#505050] flex items-center justify-center text-gray-500 dark:text-gray-300 transition">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
        </button>
        
        <div class="hidden md:flex items-center gap-2 bg-green-600 text-white px-3 py-1 rounded text-xs font-semibold cursor-default shadow-sm">
            <i class="fas fa-check-circle"></i> <span>Ready</span>
        </div>
    </div>
</header>

<div class="flex-1 flex overflow-hidden">
  
  <aside class="w-12 bg-gray-200 dark:bg-[#333333] flex flex-col items-center py-2 z-10 hidden sm:flex border-r border-gray-300 dark:border-black">
    <div class="w-12 h-12 flex justify-center items-center text-xl text-brand border-l-2 border-brand bg-white dark:bg-[#252526] cursor-pointer" title="Explorer">
      <i class="far fa-copy"></i>
    </div>
  </aside>

  <aside class="w-64 bg-gray-50 dark:bg-[#252526] flex flex-col border-r border-gray-200 dark:border-black transition-colors duration-300 min-w-[200px]">
    <div class="h-9 px-4 flex items-center text-xs font-bold text-gray-500 dark:text-gray-400 tracking-wider">
      <span>EXPLORER</span>
    </div>
    
    <div onclick="toggleTree()" class="px-2 py-1 flex items-center gap-1 cursor-pointer font-bold text-xs text-brand hover:bg-gray-200 dark:hover:bg-[#2a2d2e]">
      <i class="fas fa-chevron-down text-[10px] w-4 text-center transition-transform" id="projectArrow"></i>
      <span id="repo-name-display">PROJECT</span>
    </div>
    
    <div id="fileTree" class="flex-1 overflow-y-auto px-2 pb-2 font-sans">
      <div class="flex flex-col items-center justify-center mt-10 text-gray-400 gap-2">
        <div class="loading-spinner"></div>
        <span class="text-xs">Fetching Files...</span>
      </div>
    </div>
  </aside>

  <div class="flex-1 flex overflow-hidden relative" id="main-split-container">
    
    <div class="flex flex-col h-full bg-white dark:bg-[#1e1e1e] min-w-[200px]" id="editor-wrapper" style="width: 60%;">
        
        <div class="h-9 bg-gray-100 dark:bg-[#2d2d2d] flex overflow-x-auto border-b border-gray-200 dark:border-[#252526] shrink-0">
          <div class="flex items-center gap-2 px-3 min-w-[120px] max-w-[200px] bg-white dark:bg-[#1e1e1e] border-t-2 border-brand text-xs text-gray-700 dark:text-[#ececec] cursor-pointer">
            <i class="fas fa-code text-brand text-xs"></i>
            <span class="truncate flex-1" id="activeTabName">Welcome</span>
            <i class="fas fa-times hover:bg-gray-200 dark:hover:bg-gray-700 rounded p-0.5 transition"></i>
          </div>
        </div>

        <div class="h-6 flex items-center px-4 bg-white dark:bg-[#1e1e1e] text-[11px] text-gray-500 dark:text-gray-400 shadow-sm z-10 shrink-0">
          <span id="breadcrumbText">Select a file...</span>
        </div>

        <div class="flex-1 relative">
            <div id="editor" class="absolute inset-0"></div>
        </div>
    </div>

    <div class="gutter" id="resizer"></div>

    <div class="flex-1 flex flex-col h-full bg-white min-w-[200px]" id="preview-wrapper">
        <div class="h-9 bg-gray-100 border-b border-gray-200 flex items-center justify-between px-3 shrink-0">
            <span class="text-xs font-bold text-gray-600 uppercase flex items-center gap-2">
                <i class="fas fa-globe"></i> Live Preview
            </span>
            <button onclick="updatePreview()" title="Refresh Preview" class="text-gray-500 hover:text-brand transition w-6 h-6 flex items-center justify-center rounded hover:bg-gray-200">
                <i class="fas fa-sync-alt text-xs"></i>
            </button>
        </div>
        <iframe id="livePreview" class="flex-1 w-full bg-white border-none"></iframe>
    </div>

  </div>
</div>

<footer class="h-6 bg-brand dark:bg-[#007acc] text-white flex items-center justify-between px-3 text-[11px] select-none shrink-0 z-20">
  <div class="flex items-center gap-4">
    <div class="flex items-center gap-1 cursor-pointer hover:bg-white/20 px-1 rounded"><i class="fas fa-code-branch"></i> <span id="branch-name">main</span></div>
  </div>
  <div class="flex items-center gap-4">
    <div class="cursor-pointer hover:bg-white/20 px-1 rounded" id="cursorPos">Ln 1, Col 1</div>
    <div class="cursor-pointer hover:bg-white/20 px-1 rounded">UTF-8</div>
    <div class="cursor-pointer hover:bg-white/20 px-1 rounded font-bold" id="langMode">Plain Text</div>
  </div>
</footer>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCLafxMmbSanvmgP9KPvWXO7968BgkSMAQ",
  authDomain: "skillxchange-93fac.firebaseapp.com",
  projectId: "skillxchange-93fac",
  storageBucket: "skillxchange-93fac.appspot.com",
  messagingSenderId: "363649168062",
  appId: "1:363649168062:web:a938e95d8c7a684a1de4ef"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

/* ================= UTILITIES & STATE ================= */
const params = new URLSearchParams(window.location.search);
const projectId = params.get("id");

let GITHUB_REPO = null;
const BRANCH = "main";
let editor;
let fileCache = {};
let currentFile = null;

// Apply Theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || !savedTheme) { 
    document.documentElement.classList.add('dark');
} else {
    document.documentElement.classList.remove('dark');
}

/* ================= RESIZER LOGIC (NEW) ================= */
const resizer = document.getElementById('resizer');
const leftPane = document.getElementById('editor-wrapper');
const container = document.getElementById('main-split-container');
let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.classList.add('resizing'); // Disables iframe pointer events
    resizer.classList.add('dragging');
});

document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    
    // Calculate percentage
    const containerWidth = container.offsetWidth;
    const newLeftWidth = e.clientX - container.offsetLeft - 48; // 48 is roughly Sidebar + Activity width
    
    // Convert to percentage for responsiveness
    let percentage = (newLeftWidth / containerWidth) * 100;
    
    // Limits (20% to 80%)
    if (percentage < 20) percentage = 20;
    if (percentage > 80) percentage = 80;

    leftPane.style.width = `${percentage}%`;
    
    // Trigger Monaco resize so it fits new width
    if (editor) editor.layout();
});

document.addEventListener('mouseup', () => {
    if (isResizing) {
        isResizing = false;
        document.body.classList.remove('resizing');
        resizer.classList.remove('dragging');
        if (editor) editor.layout();
    }
});

/* ================= MONACO EDITOR SETUP ================= */
require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" } });

require(["vs/editor/editor.main"], () => {
    const isDark = document.documentElement.classList.contains('dark');

    editor = monaco.editor.create(document.getElementById("editor"), {
        value: "// Select a file from the explorer to view code...",
        language: "plaintext",
        theme: isDark ? "vs-dark" : "vs", 
        automaticLayout: true,
        fontFamily: "'JetBrains Mono', monospace",
        fontSize: 14,
        lineHeight: 24,
        minimap: { enabled: true },
        scrollBeyondLastLine: false,
        padding: { top: 16, bottom: 16 },
        renderLineHighlight: "all",
        smoothScrolling: true
    });

    editor.onDidChangeModelContent(updatePreview);
    
    editor.onDidChangeCursorPosition((e) => {
        document.getElementById("cursorPos").textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
    });
    
    // Load Data
    if (projectId) {
        loadProjectData();
    } else {
        loadMockData(); // Fallback
    }
});

/* ================= DATA LOADING ================= */
function loadProjectData() {
    db.collection("projects").doc(projectId).get().then(doc => {
        if (!doc.exists) {
            document.getElementById("fileTree").innerHTML = `<div class="p-4 text-red-500 text-xs">Project not found</div>`;
            return;
        }

        const data = doc.data();
        document.getElementById("project-header-name").innerText = data.title || "Untitled Project";
        document.getElementById("repo-name-display").innerText = data.title ? data.title.toUpperCase() : "PROJECT";

        if (!data.githubLink) {
            document.getElementById("fileTree").innerHTML = `<div class="p-4 text-gray-500 text-xs">No GitHub Link provided.</div>`;
            return;
        }

        GITHUB_REPO = extractRepo(data.githubLink);
        if (GITHUB_REPO) {
            buildTree(document.getElementById("fileTree"));
        } else {
            document.getElementById("fileTree").innerHTML = `<div class="p-4 text-red-400 text-xs">Invalid GitHub Link.</div>`;
        }
    });
}

function loadMockData() {
    setTimeout(() => {
        document.getElementById("fileTree").innerHTML = "";
        const mockFiles = [
            { name: "index.html", type: "file" },
            { name: "styles.css", type: "file" },
            { name: "app.js", type: "file" },
            { name: "readme.md", type: "file" }
        ];
        renderMockTree(document.getElementById("fileTree"), mockFiles);
    }, 500);
}

/* ================= GITHUB LOGIC ================= */
function extractRepo(link) {
  link = link.replace(/^(https?:\/\/)?(www\.)?github\.com\//, "").replace(/\/$/, "");
  const parts = link.split("/");
  return parts.length >= 2 ? `${parts[0]}/${parts[1]}` : null;
}

async function fetchTree(path = "") {
  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${path}?ref=${BRANCH}`);
    if (!res.ok) throw new Error("GitHub API failed");
    return res.json();
  } catch(e) {
    console.error(e);
    return [];
  }
}

async function buildTree(container, path = "") {
  container.innerHTML = "";
  const items = await fetchTree(path);

  items.sort((a, b) => (a.type === b.type ? 0 : a.type === "dir" ? -1 : 1));

  for (const item of items) {
    const el = document.createElement("div");
    
    if (item.type === "dir") {
      el.className = "select-none";
      el.innerHTML = `
        <div class="px-2 py-1 flex items-center gap-2 cursor-pointer text-[13px] text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-[#2a2d2e] rounded-sm transition">
            <i class="fas fa-folder text-yellow-500 text-xs transition-transform duration-200"></i>
            <span class="truncate">${item.name}</span>
        </div>
        <div class="pl-4 border-l border-gray-200 dark:border-[#333] ml-[9px] hidden"></div>
      `;
      
      const subContainer = el.querySelector("div:last-child");
      const row = el.querySelector("div:first-child");

      row.onclick = async (e) => {
        e.stopPropagation();
        const icon = row.querySelector("i");
        if (subContainer.classList.contains("hidden")) {
            subContainer.classList.remove("hidden");
            icon.classList.remove("fa-folder");
            icon.classList.add("fa-folder-open");
            if(subContainer.innerHTML === "") await buildTree(subContainer, item.path);
        } else {
            subContainer.classList.add("hidden");
            icon.classList.remove("fa-folder-open");
            icon.classList.add("fa-folder");
        }
      };
      container.appendChild(el);

    } else {
      el.className = "px-2 py-1 flex items-center gap-2 cursor-pointer text-[13px] text-gray-600 dark:text-[#cccccc] hover:bg-gray-200 dark:hover:bg-[#2a2d2e] rounded-sm transition file-item";
      el.innerHTML = `${getIconClass(item.name)} <span class="truncate">${item.name}</span>`;
      el.onclick = () => {
          document.querySelectorAll('.file-item').forEach(x => x.classList.remove('bg-gray-300', 'dark:bg-[#37373d]'));
          el.classList.add('bg-gray-300', 'dark:bg-[#37373d]');
          openFile(item);
      };
      container.appendChild(el);
    }
  }
}

function getIconClass(filename) {
    const ext = filename.split(".").pop();
    let color = "text-gray-400";
    let icon = "fa-file";
    
    if(ext === 'html') { icon = "fa-html5"; color="text-orange-500"; }
    else if(ext === 'css') { icon = "fa-css3-alt"; color="text-blue-500"; }
    else if(ext === 'js') { icon = "fa-js"; color="text-yellow-400"; }
    else if(ext === 'json') { icon = "fa-code"; color="text-yellow-600"; }
    else if(ext === 'md') { icon = "fa-markdown"; color="text-blue-300"; }
    
    return `<i class="fab ${icon} ${color} text-xs w-4 text-center"></i>`;
}

async function openFile(file) {
  if (!fileCache[file.path]) {
    try {
        const res = await fetch(file.download_url);
        fileCache[file.path] = await res.text();
    } catch(e) {
        editor.setValue("// Error loading file content");
        return;
    }
  }

  currentFile = file.path;
  editor.setValue(fileCache[file.path]);

  document.getElementById("activeTabName").innerText = file.name;
  document.getElementById("breadcrumbText").innerText = file.path.replace(/\//g, " > ");

  const ext = file.name.split(".").pop();
  const lang = languageFromExt(ext);
  
  monaco.editor.setModelLanguage(editor.getModel(), lang);
  updateStatusBar(lang);
  updatePreview();
}

function toggleTheme() {
    const html = document.documentElement;
    if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        if(editor) monaco.editor.setTheme("vs");
    } else {
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        if(editor) monaco.editor.setTheme("vs-dark");
    }
}

function updatePreview() {
  if (!currentFile) return;
  fileCache[currentFile] = editor.getValue();
  
  const html = fileCache["index.html"] || "";
  const css = fileCache["style.css"] || fileCache["styles.css"] || "";
  const js = fileCache["script.js"] || fileCache["app.js"] || "";

  const docStr = `
    <html>
      <head>
        <style>${css}</style>
      </head>
      <body>
        ${html}
        <script>try{${js}}catch(e){console.error(e)}<\/script>
      </body>
    </html>
  `;
  document.getElementById("livePreview").srcdoc = docStr;
}

function languageFromExt(ext) {
  const map = { js: "javascript", html: "html", css: "css", md: "markdown", json: "json", py: "python" };
  return map[ext] || "plaintext";
}

function updateStatusBar(lang) {
    document.getElementById("langMode").innerText = lang.toUpperCase();
}

function toggleTree() {
    const tree = document.getElementById('fileTree');
    const arrow = document.getElementById('projectArrow');
    tree.classList.toggle('hidden');
    arrow.style.transform = tree.classList.contains('hidden') ? "rotate(-90deg)" : "rotate(0deg)";
}

// Fallback Mock Render
function renderMockTree(container, items) {
    items.forEach(item => {
        const el = document.createElement("div");
        el.className = "px-2 py-1 flex items-center gap-2 cursor-pointer text-[13px] text-gray-600 dark:text-[#cccccc] hover:bg-gray-200 dark:hover:bg-[#2a2d2e] rounded-sm transition file-item";
        el.innerHTML = `${getIconClass(item.name)} <span class="truncate">${item.name}</span>`;
        el.onclick = () => {
            document.querySelectorAll('.file-item').forEach(x => x.classList.remove('bg-gray-300', 'dark:bg-[#37373d]'));
            el.classList.add('bg-gray-300', 'dark:bg-[#37373d]');
            document.getElementById("activeTabName").innerText = item.name;
            editor.setValue(`\n<h1>Hello World</h1>`);
        }
        container.appendChild(el);
    });
}
</script>
</body>
</html>